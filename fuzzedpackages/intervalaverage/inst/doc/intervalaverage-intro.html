<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="date" content="2020-07-16" />

<title>Introduction to intervalaverage</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to intervalaverage</h1>
<h4 class="date">2020-07-16</h4>



<p>This package and vignette makes extensive use of <code>data.table</code>. If you’re unfamiliar with the <code>data.table</code> syntax, a brief review of that package’s introductory vignette may be useful.</p>
<div id="averaging-values-measured-over-intervals" class="section level2">
<h2>Averaging values measured over intervals</h2>
<p>Consider the following dataset which represents average (predicted) pm2.5 exposure and no2 exposure at some location over four sequential 7-day periods at the beginning of the year 2000:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">exposure_dataset &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">location_id=</span><span class="dv">1</span>, <span class="dt">start=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-01&quot;</span>),<span class="dt">by=</span><span class="dv">7</span>,<span class="dt">length=</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">                <span class="dt">end=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-07&quot;</span>),<span class="dt">by=</span><span class="dv">7</span>,<span class="dt">length=</span><span class="dv">4</span>),<span class="dt">pm25=</span><span class="kw">rnorm</span>(<span class="dv">4</span>,<span class="dt">mean=</span><span class="dv">15</span>), <span class="dt">no2=</span><span class="kw">rnorm</span>(<span class="dv">4</span>,<span class="dt">mean=</span><span class="dv">25</span>))</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">exposure_dataset</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt;    location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; 1:           1 2000-01-01 2000-01-07 14.37355 25.32951</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt; 2:           1 2000-01-08 2000-01-14 15.18364 24.17953</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#&gt; 3:           1 2000-01-15 2000-01-21 14.16437 25.48743</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#&gt; 4:           1 2000-01-22 2000-01-28 16.59528 25.73832</span></a></code></pre></div>
<p>Note that the above intervals are stored as a column for the start of the interval and a column for the end of the interval. For the purpose of this package, intervals are ALWAYS treated as closed (i.e. inclusive of start and end values) and the variables storing interval starts and ends must be discrete (e.g., class integer or IDate).</p>
<p>If we wanted to calculate the average of the first two weeks of pm25 data, this would simply be the average of the two pm25 values for those weeks:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">exposure_dataset[start <span class="op">%in%</span><span class="st"> </span><span class="kw">as.IDate</span>(<span class="kw">c</span>(<span class="st">&quot;2000-01-01&quot;</span>,<span class="st">&quot;2000-01-08&quot;</span>)),<span class="kw">mean</span>(pm25)]</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt; [1] 14.77859</span></a></code></pre></div>
<p>But we wanted the average of the first 10 days of that pm25 data, we would need to take a weighted average since the period from Jan 1 to Jan 10 doesn’t align perfectly with the intervals over which the pm2.5 data is recorded:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">exposure_dataset[start <span class="op">%in%</span><span class="st"> </span><span class="kw">as.IDate</span>(<span class="kw">c</span>(<span class="st">&quot;2000-01-01&quot;</span>,<span class="st">&quot;2000-01-08&quot;</span>)),<span class="kw">weighted.mean</span>(pm25,<span class="dt">w=</span><span class="kw">c</span>(<span class="dv">7</span><span class="op">/</span><span class="dv">10</span>,<span class="dv">3</span><span class="op">/</span><span class="dv">10</span>))]</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; [1] 14.61658</span></a></code></pre></div>
<p>The <code>intervalaverage</code> package and specifically the <code>intervalaverage</code> function was written to facilitate this sort averaging operation. In order to use this the package function, we’ll need a dataset containing data that’s stored over intervals (such as in <code>exposure_dataset</code>) as well as a dataset containing the periods you’d like to average over.</p>
<p>Let’s create a dataset containing some periods we’d like averages over:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">averaging_periods &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">start=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-01&quot;</span>),<span class="dt">by=</span><span class="dv">10</span>,<span class="dt">length=</span><span class="dv">3</span>),</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                <span class="dt">end=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-10&quot;</span>),<span class="dt">by=</span><span class="dv">10</span>,<span class="dt">length=</span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">averaging_periods</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt;         start        end</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; 1: 2000-01-01 2000-01-10</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; 2: 2000-01-11 2000-01-20</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt; 3: 2000-01-21 2000-01-30</span></a></code></pre></div>
<p>Now that we have defined intervals to average over, let’s use the <code>intervalaverage</code> function to calculate the averages:</p>
<p>Note that in order for the intervalaverage function to work, the start and end columns need to have the same column names in <code>x</code> and in <code>y</code>. These column names are specified via the <code>interval_vars</code> argument. And the variables in <code>x</code> that you want averages calculated for are specified via <code>value_vars</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">averaged_exposures &lt;-<span class="st"> </span><span class="kw">intervalaverage</span>(<span class="dt">x=</span>exposure_dataset,<span class="dt">y=</span>averaging_periods,</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">                                      <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),<span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">                                      )</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">averaged_exposures[, <span class="kw">list</span>(start,end,pm25,no2)]</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt;         start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; 1: 2000-01-01 2000-01-10 14.61658 24.98451</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt; 2: 2000-01-11 2000-01-20 14.57208 24.96427</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt; 3: 2000-01-21 2000-01-30       NA       NA</span></a></code></pre></div>
<p>The return value of the <code>intervalaverage</code> function is a <code>data.table</code>. Just the first four columns of that return data.table are printed. The return data.table always contains the exact intervals specified in y (and, as such, the number of rows of the return is always the number of rows in <code>y</code>). The return also contains a column for each <code>value_var</code> specified from x. These columns contain the values of the variables from <code>x</code> averaged over periods in <code>y</code>. Note that the value of the pm25 in the first row is what we calculated manually above.</p>
<p>Note that the third entry for both the <code>pm25</code> and the <code>no2</code> column is <code>NA</code> or missing. This makes sense because the <code>x</code> ( <code>exposure_dataset</code>) didn’t have measurements for every day in the interval in <code>y</code> (<code>averaging_periods</code>) from Jan 21, 2000 to Jan 30, 2000.</p>
<p>Displaying the full data.table returned by the function gives us some more information:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">averaged_exposures</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt;         start        end     pm25      no2 yduration xduration nobs_pm25</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt; 1: 2000-01-01 2000-01-10 14.61658 24.98451        10        10        10</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; 2: 2000-01-11 2000-01-20 14.57208 24.96427        10        10        10</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt; 3: 2000-01-21 2000-01-30       NA       NA        10         8         8</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt;    nobs_no2  xminstart    xmaxend</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; 1:       10 2000-01-01 2000-01-10</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; 2:       10 2000-01-11 2000-01-20</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; 3:        8 2000-01-21 2000-01-28</span></a></code></pre></div>
<p>The <code>xduration</code> column tells us the number of days that were present in <code>x</code> for each interval specified in <code>y</code>. The first two <code>averaging_periods</code> intervals were fully represented in <code>x</code>, whereas <code>x</code> only contained data for 8 of the 10 days in the third <code>y</code> interval. The <code>xmaxend</code> column shows us that the last day in the interval from Jan 21,2000 to Jan 30, 2000 that was present in <code>y</code> was Jan 28, 2000.</p>
<p>These supplementary columns are useful for diagnosing incomplete data in <code>exposure_dataset</code>.</p>
<p>If we’re ok with calculating an average based on incomplete data, we can set the the tolerance for missingness lower. Let’s say we’re ok with calculating a non-missing average if 75% or more of the period is observed:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">intervalaverage</span>(<span class="dt">x=</span>exposure_dataset,</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                <span class="dt">y=</span>averaging_periods,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                <span class="dt">required_percentage =</span> <span class="dv">75</span>)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt;         start        end     pm25      no2 yduration xduration nobs_pm25</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; 1: 2000-01-01 2000-01-10 14.61658 24.98451        10        10        10</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt; 2: 2000-01-11 2000-01-20 14.57208 24.96427        10        10        10</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; 3: 2000-01-21 2000-01-30 16.29142 25.70696        10         8         8</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt;    nobs_no2  xminstart    xmaxend</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt; 1:       10 2000-01-01 2000-01-10</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt; 2:       10 2000-01-11 2000-01-20</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt; 3:        8 2000-01-21 2000-01-28</span></a></code></pre></div>
<p>The results are the same for the first two rows but now we have nonmissing values in the third which are calculated based on the available data in <code>exposure_dataset</code>. If there had been a period with less than 75% of the data present, the function would still return <code>NA</code> for those value variables.</p>
</div>
<div id="averaging-within-values-of-a-grouping-variable-e.g.at-multiple-locations" class="section level2">
<h2>Averaging within values of a grouping variable (e.g. at multiple locations)</h2>
<p>Often, we might have interval data at more than one location or identifier at a time. Let’s create a data.table similar to <code>exposure_dataset</code> but with several (three) locations:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">exposure_dataset2 &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(z){</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="kw">data.table</span>(<span class="dt">location_id=</span>z, </a>
<a class="sourceLine" id="cb8-3" data-line-number="3">             <span class="dt">start=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-01&quot;</span>),<span class="dt">by=</span><span class="dv">7</span>,<span class="dt">length=</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">             <span class="dt">end=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-07&quot;</span>),<span class="dt">by=</span><span class="dv">7</span>,<span class="dt">length=</span><span class="dv">4</span>),<span class="dt">pm25=</span><span class="kw">rnorm</span>(<span class="dv">4</span>,<span class="dt">mean=</span><span class="dv">15</span>),</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">             <span class="dt">no2=</span><span class="kw">rnorm</span>(<span class="dv">4</span>,<span class="dt">mean=</span><span class="dv">25</span>))} ))</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">exposure_dataset2</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt;     location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt;  1:           1 2000-01-01 2000-01-07 15.57578 24.37876</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt;  2:           1 2000-01-08 2000-01-14 14.69461 22.78530</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#&gt;  3:           1 2000-01-15 2000-01-21 16.51178 26.12493</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt;  4:           1 2000-01-22 2000-01-28 15.38984 24.95507</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt;  5:           2 2000-01-01 2000-01-07 14.98381 25.91898</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt;  6:           2 2000-01-08 2000-01-14 15.94384 25.78214</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#&gt;  7:           2 2000-01-15 2000-01-21 15.82122 25.07456</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt;  8:           2 2000-01-22 2000-01-28 15.59390 23.01065</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16"><span class="co">#&gt;  9:           3 2000-01-01 2000-01-07 15.61983 24.52185</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="co">#&gt; 10:           3 2000-01-08 2000-01-14 14.94387 25.41794</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="co">#&gt; 11:           3 2000-01-15 2000-01-21 14.84420 26.35868</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19"><span class="co">#&gt; 12:           3 2000-01-22 2000-01-28 13.52925 24.89721</span></a></code></pre></div>
<p>If you want to use the <code>intervalaverage</code> function to calculate averages of values in <code>x</code> over a set of averaging periods separately for each level of an identifier variable, that identifier variable needs to be crossed with every averaging period in <code>y</code>. It takes an extra step to cross the identifier with the averaging periods to create <code>y</code>, but in creating <code>y</code> this way you explicitly define the form of the return value of <code>intervalaverage</code>, since <code>intervalaverage</code> always returns one row for each row in <code>y</code>.</p>
<p>Let’s cross the previous averaging periods table with every unique value of the identifier in the new exposure dataset:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">#unexpanded:</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">averaging_periods</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt;         start        end</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; 1: 2000-01-01 2000-01-10</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; 2: 2000-01-11 2000-01-20</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; 3: 2000-01-21 2000-01-30</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#expanded to every location_id:</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(z)<span class="kw">copy</span>(averaging_periods)[,location_id<span class="op">:</span><span class="er">=</span>z][])) </a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">#&gt;         start        end location_id</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; 1: 2000-01-01 2000-01-10           1</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; 2: 2000-01-11 2000-01-20           1</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co">#&gt; 3: 2000-01-21 2000-01-30           1</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co">#&gt; 4: 2000-01-01 2000-01-10           2</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="co">#&gt; 5: 2000-01-11 2000-01-20           2</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co">#&gt; 6: 2000-01-21 2000-01-30           2</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="co">#&gt; 7: 2000-01-01 2000-01-10           3</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#&gt; 8: 2000-01-11 2000-01-20           3</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"><span class="co">#&gt; 9: 2000-01-21 2000-01-30           3</span></a></code></pre></div>
<p>The above code is a bit esoteric so the intervalaverage package contains function to simplify and generalize this process of repeating/expanding a set of intervals (or more generally, a set of rows in a table) for every <code>location_id</code> (or more generally, for every row in another table). To use this <code>CJ.dt</code> function, just create a <code>data.table</code> with a column containing unique ids, then call <code>CJ.dt</code> on the two tables:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">exposure_dataset2_unique_locs &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">location_id=</span><span class="kw">unique</span>(exposure_dataset2<span class="op">$</span>location_id))</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">averaging_periods2 &lt;-<span class="st"> </span><span class="kw">CJ.dt</span>(averaging_periods, exposure_dataset2_unique_locs)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">averaging_periods2</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt;         start        end location_id</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt; 1: 2000-01-01 2000-01-10           1</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt; 2: 2000-01-11 2000-01-20           1</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt; 3: 2000-01-21 2000-01-30           1</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">#&gt; 4: 2000-01-01 2000-01-10           2</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt; 5: 2000-01-11 2000-01-20           2</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt; 6: 2000-01-21 2000-01-30           2</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#&gt; 7: 2000-01-01 2000-01-10           3</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#&gt; 8: 2000-01-11 2000-01-20           3</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#&gt; 9: 2000-01-21 2000-01-30           3</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">#or, more concisely:</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">averaging_periods2 &lt;-<span class="st"> </span><span class="kw">CJ.dt</span>(averaging_periods, <span class="kw">unique</span>(exposure_dataset2[,<span class="kw">list</span>(location_id)]))</a></code></pre></div>
<p>Now, to take averages of <code>x</code> values over intervals in <code>y</code> within groups, all we have to do is use the same call as in the first example to <code>intervalaverage</code> while specifying one more argument: <code>group_vars=&quot;location_id&quot;</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">intervalaverage</span>(<span class="dt">x=</span>exposure_dataset2,</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">                <span class="dt">y=</span>averaging_periods2,</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">                <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">                <span class="dt">group_vars=</span><span class="st">&quot;location_id&quot;</span>,</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">                <span class="dt">required_percentage =</span> <span class="dv">75</span>)[, <span class="kw">list</span>(location_id, start,end, pm25,no2)]</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt;    location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; 1:           1 2000-01-01 2000-01-10 15.31143 23.90072</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt; 2:           1 2000-01-11 2000-01-20 15.78491 24.78908</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt; 3:           1 2000-01-21 2000-01-30 15.53009 25.10130</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt; 4:           2 2000-01-01 2000-01-10 15.27182 25.87793</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt; 5:           2 2000-01-11 2000-01-20 15.87027 25.35759</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt; 6:           2 2000-01-21 2000-01-30 15.62232 23.26864</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; 7:           3 2000-01-01 2000-01-10 15.41704 24.79068</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">#&gt; 8:           3 2000-01-11 2000-01-20 14.88407 25.98238</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt; 9:           3 2000-01-21 2000-01-30 13.69362 25.07990</span></a></code></pre></div>
<p>The <code>group_vars</code> argument tells the <code>intervalaverage</code> function to calculate averages separately within each group.</p>
<p>Of course, we could have completed the above by calling <code>intervalaverage</code> repeatedly for each value of <code>location_id</code> in <code>x</code> and <code>y</code> using a for loop. The reason to prefer using the <code>group_vars</code> approach is that the <code>intervalaverage</code> function is written to be faster than looping when with dealing with grouping. It also saves you the trouble of writing a loop and combining the results.</p>
<p>Additionally, <code>group_vars</code> accepts a vector of character column names, meaning that you can calculate averages within combinations of groups without writing nested for loops.</p>
</div>
<div id="values-in-overlapping-periods-are-not-allowed" class="section level2">
<h2>Values in overlapping periods are not allowed</h2>
<p>Note that all the intervals used in this package are treated as inclusive. So far, we’ve dealt with data which have intervals which do not overlap. However, consider the following dataset where the end day of a previous interval is the start day of the next interval:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">exposure_dataset_overlapping &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="cf">function</span>(z){</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  <span class="kw">data.table</span>(<span class="dt">location_id=</span>z, </a>
<a class="sourceLine" id="cb12-3" data-line-number="3">             <span class="dt">start=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-01&quot;</span>),<span class="dt">by=</span><span class="dv">7</span>,<span class="dt">length=</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">             <span class="dt">end=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-08&quot;</span>),<span class="dt">by=</span><span class="dv">7</span>,<span class="dt">length=</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">             <span class="dt">pm25=</span><span class="kw">rnorm</span>(<span class="dv">4</span>,<span class="dt">mean=</span><span class="dv">15</span>),</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">             <span class="dt">no2=</span><span class="kw">rnorm</span>(<span class="dv">4</span>,<span class="dt">mean=</span><span class="dv">25</span>) )</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">} ))</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">exposure_dataset_overlapping</a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#&gt;     location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt;  1:           1 2000-01-01 2000-01-08 15.38767 24.60571</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co">#&gt;  2:           1 2000-01-08 2000-01-15 14.94619 24.94069</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt;  3:           1 2000-01-15 2000-01-22 13.62294 26.10003</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt;  4:           1 2000-01-22 2000-01-29 14.58501 25.76318</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt;  5:           2 2000-01-01 2000-01-08 14.83548 24.31124</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt;  6:           2 2000-01-08 2000-01-15 14.74664 24.29250</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt;  7:           2 2000-01-15 2000-01-22 15.69696 25.36458</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt;  8:           2 2000-01-22 2000-01-29 15.55666 25.76853</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt;  9:           3 2000-01-01 2000-01-08 14.88765 25.34112</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#&gt; 10:           3 2000-01-08 2000-01-15 15.88111 23.87064</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#&gt; 11:           3 2000-01-15 2000-01-22 15.39811 26.43302</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#&gt; 12:           3 2000-01-22 2000-01-29 14.38797 26.98040</span></a></code></pre></div>
<p>If we try to average this exposure dataset, we get an error:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">intervalaverage</span>(exposure_dataset_overlapping,averaging_periods2,</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">                <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">                <span class="dt">group_vars=</span><span class="st">&quot;location_id&quot;</span>,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">                <span class="dt">required_percentage =</span> <span class="dv">75</span>)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt; Error in intervalaverage(exposure_dataset_overlapping, averaging_periods2, : nrow(data.table::foverlaps(x, x)) == nrow(x) is not TRUE</span></a></code></pre></div>
<p>That’s because the <code>intervalaverage</code> function is written to throw an error if there are overlaps in within groups. This is to encourage the user to explicitly and consciously deal with overlaps prior to averaging.</p>
<p>Note that we can also check whether there are overlapping intervals (within specified groups) using <code>is.overlapping</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">is.overlapping</span>(exposure_dataset_overlapping, <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">'start'</span>,<span class="st">'end'</span>),<span class="dt">group_vars=</span><span class="st">&quot;location_id&quot;</span>)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>In order to deal with partially overlapping intervals, we need to split intervals into areas of exact overlap and non-overlap with the <code>isolateoverlaps</code> function:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">exposure_dataset_isolated &lt;-<span class="st"> </span><span class="kw">isolateoverlaps</span>(exposure_dataset_overlapping, </a>
<a class="sourceLine" id="cb15-2" data-line-number="2">                                             <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>), </a>
<a class="sourceLine" id="cb15-3" data-line-number="3">                                             <span class="dt">group_vars=</span><span class="st">&quot;location_id&quot;</span>,</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">                                             <span class="dt">interval_vars_out=</span><span class="kw">c</span>(<span class="st">&quot;start2&quot;</span>,<span class="st">&quot;end2&quot;</span>))</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">exposure_dataset_isolated[<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>] <span class="co">#only show the first 15 rows</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt;     location_id     start2       end2      start        end     pm25</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt;  1:           1 2000-01-01 2000-01-07 2000-01-01 2000-01-08 15.38767</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt;  2:           1 2000-01-08 2000-01-08 2000-01-01 2000-01-08 15.38767</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt;  3:           1 2000-01-08 2000-01-08 2000-01-08 2000-01-15 14.94619</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#&gt;  4:           1 2000-01-09 2000-01-14 2000-01-08 2000-01-15 14.94619</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt;  5:           1 2000-01-15 2000-01-15 2000-01-08 2000-01-15 14.94619</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co">#&gt;  6:           1 2000-01-15 2000-01-15 2000-01-15 2000-01-22 13.62294</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt;  7:           1 2000-01-16 2000-01-21 2000-01-15 2000-01-22 13.62294</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co">#&gt;  8:           1 2000-01-22 2000-01-22 2000-01-15 2000-01-22 13.62294</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="co">#&gt;  9:           1 2000-01-22 2000-01-22 2000-01-22 2000-01-29 14.58501</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="co">#&gt; 10:           1 2000-01-23 2000-01-29 2000-01-22 2000-01-29 14.58501</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="co">#&gt; 11:           2 2000-01-01 2000-01-07 2000-01-01 2000-01-08 14.83548</span></a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="co">#&gt; 12:           2 2000-01-08 2000-01-08 2000-01-01 2000-01-08 14.83548</span></a>
<a class="sourceLine" id="cb15-19" data-line-number="19"><span class="co">#&gt; 13:           2 2000-01-08 2000-01-08 2000-01-08 2000-01-15 14.74664</span></a>
<a class="sourceLine" id="cb15-20" data-line-number="20"><span class="co">#&gt; 14:           2 2000-01-09 2000-01-14 2000-01-08 2000-01-15 14.74664</span></a>
<a class="sourceLine" id="cb15-21" data-line-number="21"><span class="co">#&gt; 15:           2 2000-01-15 2000-01-15 2000-01-08 2000-01-15 14.74664</span></a>
<a class="sourceLine" id="cb15-22" data-line-number="22"><span class="co">#&gt;          no2</span></a>
<a class="sourceLine" id="cb15-23" data-line-number="23"><span class="co">#&gt;  1: 24.60571</span></a>
<a class="sourceLine" id="cb15-24" data-line-number="24"><span class="co">#&gt;  2: 24.60571</span></a>
<a class="sourceLine" id="cb15-25" data-line-number="25"><span class="co">#&gt;  3: 24.94069</span></a>
<a class="sourceLine" id="cb15-26" data-line-number="26"><span class="co">#&gt;  4: 24.94069</span></a>
<a class="sourceLine" id="cb15-27" data-line-number="27"><span class="co">#&gt;  5: 24.94069</span></a>
<a class="sourceLine" id="cb15-28" data-line-number="28"><span class="co">#&gt;  6: 26.10003</span></a>
<a class="sourceLine" id="cb15-29" data-line-number="29"><span class="co">#&gt;  7: 26.10003</span></a>
<a class="sourceLine" id="cb15-30" data-line-number="30"><span class="co">#&gt;  8: 26.10003</span></a>
<a class="sourceLine" id="cb15-31" data-line-number="31"><span class="co">#&gt;  9: 25.76318</span></a>
<a class="sourceLine" id="cb15-32" data-line-number="32"><span class="co">#&gt; 10: 25.76318</span></a>
<a class="sourceLine" id="cb15-33" data-line-number="33"><span class="co">#&gt; 11: 24.31124</span></a>
<a class="sourceLine" id="cb15-34" data-line-number="34"><span class="co">#&gt; 12: 24.31124</span></a>
<a class="sourceLine" id="cb15-35" data-line-number="35"><span class="co">#&gt; 13: 24.29250</span></a>
<a class="sourceLine" id="cb15-36" data-line-number="36"><span class="co">#&gt; 14: 24.29250</span></a>
<a class="sourceLine" id="cb15-37" data-line-number="37"><span class="co">#&gt; 15: 24.29250</span></a></code></pre></div>
<p>Inspect the above table and compare it to <code>exposure_dataset</code>. <code>start2</code> and <code>end2</code> are the new intervals and <code>start</code> and <code>end</code> are the original intervals. Note how there are two rows for every overlapping period (ie in the <code>start2</code> and <code>end2</code> columns), but the pm25 and no2 values differ within these rows since one value comes from the first overlapping period and the second value comes from the second overlapping period.</p>
<p>We can then average exposure values within periods of exact overlap:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">exposure_dataset_overlaps_averaged &lt;-</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">  </span>exposure_dataset_isolated[, <span class="kw">list</span>(<span class="dt">pm25=</span><span class="kw">mean</span>(pm25),<span class="dt">no2=</span><span class="kw">mean</span>(no2)),by=<span class="kw">c</span>(<span class="st">&quot;location_id&quot;</span>,<span class="st">&quot;start2&quot;</span>,<span class="st">&quot;end2&quot;</span>)]</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="kw">setnames</span>(exposure_dataset_overlaps_averaged, <span class="kw">c</span>(<span class="st">&quot;start2&quot;</span>,<span class="st">&quot;end2&quot;</span>),<span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>))</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">exposure_dataset_overlaps_averaged</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt;     location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt;  1:           1 2000-01-01 2000-01-07 15.38767 24.60571</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">#&gt;  2:           1 2000-01-08 2000-01-08 15.16693 24.77320</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co">#&gt;  3:           1 2000-01-09 2000-01-14 14.94619 24.94069</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="co">#&gt;  4:           1 2000-01-15 2000-01-15 14.28457 25.52036</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="co">#&gt;  5:           1 2000-01-16 2000-01-21 13.62294 26.10003</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="co">#&gt;  6:           1 2000-01-22 2000-01-22 14.10397 25.93160</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="co">#&gt;  7:           1 2000-01-23 2000-01-29 14.58501 25.76318</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="co">#&gt;  8:           2 2000-01-01 2000-01-07 14.83548 24.31124</span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="co">#&gt;  9:           2 2000-01-08 2000-01-08 14.79106 24.30187</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="co">#&gt; 10:           2 2000-01-09 2000-01-14 14.74664 24.29250</span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="co">#&gt; 11:           2 2000-01-15 2000-01-15 15.22180 24.82854</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="co">#&gt; 12:           2 2000-01-16 2000-01-21 15.69696 25.36458</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19"><span class="co">#&gt; 13:           2 2000-01-22 2000-01-22 15.62681 25.56656</span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20"><span class="co">#&gt; 14:           2 2000-01-23 2000-01-29 15.55666 25.76853</span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21"><span class="co">#&gt; 15:           3 2000-01-01 2000-01-07 14.88765 25.34112</span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22"><span class="co">#&gt; 16:           3 2000-01-08 2000-01-08 15.38438 24.60588</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23"><span class="co">#&gt; 17:           3 2000-01-09 2000-01-14 15.88111 23.87064</span></a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="co">#&gt; 18:           3 2000-01-15 2000-01-15 15.63961 25.15183</span></a>
<a class="sourceLine" id="cb16-25" data-line-number="25"><span class="co">#&gt; 19:           3 2000-01-16 2000-01-21 15.39811 26.43302</span></a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="co">#&gt; 20:           3 2000-01-22 2000-01-22 14.89304 26.70671</span></a>
<a class="sourceLine" id="cb16-27" data-line-number="27"><span class="co">#&gt; 21:           3 2000-01-23 2000-01-29 14.38797 26.98040</span></a>
<a class="sourceLine" id="cb16-28" data-line-number="28"><span class="co">#&gt;     location_id      start        end     pm25      no2</span></a></code></pre></div>
<p>This version of the dataset where values in overlapping periods have already been averaged can now be averaged to the times in <code>averaging_periods2</code> using the <code>intervalaverage</code> function:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">intervalaverage</span>(exposure_dataset_overlaps_averaged,</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">                averaging_periods2,</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">                <span class="dt">group_vars=</span><span class="st">&quot;location_id&quot;</span>,</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">                <span class="dt">required_percentage =</span> <span class="dv">75</span>)[,<span class="kw">list</span>(location_id, start,end,pm25,no2)]</a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">#&gt;    location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">#&gt; 1:           1 2000-01-01 2000-01-10 15.27730 24.68945</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co">#&gt; 2:           1 2000-01-11 2000-01-20 14.21840 25.57832</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="co">#&gt; 3:           1 2000-01-21 2000-01-30 14.42466 25.81932</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="co">#&gt; 4:           2 2000-01-01 2000-01-10 14.81327 24.30656</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="co">#&gt; 5:           2 2000-01-11 2000-01-20 15.26932 24.88215</span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13"><span class="co">#&gt; 6:           2 2000-01-21 2000-01-30 15.58005 25.70121</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="co">#&gt; 7:           3 2000-01-01 2000-01-10 15.13602 24.97350</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15"><span class="co">#&gt; 8:           3 2000-01-11 2000-01-20 15.61546 25.27995</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16"><span class="co">#&gt; 9:           3 2000-01-21 2000-01-30 14.55633 26.88917</span></a></code></pre></div>
</div>
<div id="overlapping-averaging-periods" class="section level2">
<h2>Overlapping averaging periods</h2>
<p>While overlapping periods in <code>x</code> are not allowed, there’s nothing wrong with averaging to multiple partially overlapping periods in y at the same time:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">overlapping_averaging_periods &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">start=</span><span class="kw">as.IDate</span>(<span class="kw">c</span>(<span class="st">&quot;2000-01-01&quot;</span>,<span class="st">&quot;2000-01-01&quot;</span>)),</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">                                            <span class="dt">end=</span><span class="kw">as.IDate</span>(<span class="kw">c</span>(<span class="st">&quot;2000-01-10&quot;</span>,<span class="st">&quot;2000-01-20&quot;</span>))</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">                                            )</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">overlapping_averaging_periods</a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="co">#&gt;         start        end</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="co">#&gt; 1: 2000-01-01 2000-01-10</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="co">#&gt; 2: 2000-01-01 2000-01-20</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9">overlapping_averaging_periods_expanded &lt;-</a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="st">  </span><span class="kw">CJ.dt</span>(overlapping_averaging_periods,<span class="kw">unique</span>(exposure_dataset2[,<span class="kw">list</span>(location_id)]))</a>
<a class="sourceLine" id="cb18-11" data-line-number="11"></a>
<a class="sourceLine" id="cb18-12" data-line-number="12">overlapping_averaging_periods_expanded</a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="co">#&gt;         start        end location_id</span></a>
<a class="sourceLine" id="cb18-14" data-line-number="14"><span class="co">#&gt; 1: 2000-01-01 2000-01-10           1</span></a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="co">#&gt; 2: 2000-01-01 2000-01-20           1</span></a>
<a class="sourceLine" id="cb18-16" data-line-number="16"><span class="co">#&gt; 3: 2000-01-01 2000-01-10           2</span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17"><span class="co">#&gt; 4: 2000-01-01 2000-01-20           2</span></a>
<a class="sourceLine" id="cb18-18" data-line-number="18"><span class="co">#&gt; 5: 2000-01-01 2000-01-10           3</span></a>
<a class="sourceLine" id="cb18-19" data-line-number="19"><span class="co">#&gt; 6: 2000-01-01 2000-01-20           3</span></a>
<a class="sourceLine" id="cb18-20" data-line-number="20"></a>
<a class="sourceLine" id="cb18-21" data-line-number="21"></a>
<a class="sourceLine" id="cb18-22" data-line-number="22"><span class="kw">intervalaverage</span>(exposure_dataset_overlaps_averaged,</a>
<a class="sourceLine" id="cb18-23" data-line-number="23">                overlapping_averaging_periods_expanded,</a>
<a class="sourceLine" id="cb18-24" data-line-number="24">                <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb18-25" data-line-number="25">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),</a>
<a class="sourceLine" id="cb18-26" data-line-number="26">                <span class="dt">group_vars=</span><span class="st">&quot;location_id&quot;</span>,</a>
<a class="sourceLine" id="cb18-27" data-line-number="27">                <span class="dt">required_percentage =</span> <span class="dv">75</span>)[,<span class="kw">list</span>(location_id, start,end,pm25,no2)]</a>
<a class="sourceLine" id="cb18-28" data-line-number="28"><span class="co">#&gt;    location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb18-29" data-line-number="29"><span class="co">#&gt; 1:           1 2000-01-01 2000-01-10 15.27730 24.68945</span></a>
<a class="sourceLine" id="cb18-30" data-line-number="30"><span class="co">#&gt; 2:           1 2000-01-01 2000-01-20 14.74785 25.13389</span></a>
<a class="sourceLine" id="cb18-31" data-line-number="31"><span class="co">#&gt; 3:           2 2000-01-01 2000-01-10 14.81327 24.30656</span></a>
<a class="sourceLine" id="cb18-32" data-line-number="32"><span class="co">#&gt; 4:           2 2000-01-01 2000-01-20 15.04129 24.59435</span></a>
<a class="sourceLine" id="cb18-33" data-line-number="33"><span class="co">#&gt; 5:           3 2000-01-01 2000-01-10 15.13602 24.97350</span></a>
<a class="sourceLine" id="cb18-34" data-line-number="34"><span class="co">#&gt; 6:           3 2000-01-01 2000-01-20 15.37574 25.12672</span></a></code></pre></div>
<p>Note that if you specify identical intervals (within groups defined by <code>group_vars</code>), duplicate intervals in <code>y</code> will be dropped with a warning resulting in a return data.table with fewer rows than in <code>y</code>.</p>
</div>
<div id="averaging-values-measured-over-intervals-different-averaging-periods-for-different-groups" class="section level2">
<h2>Averaging values measured over intervals: different averaging periods for different groups</h2>
<p>Often we’re interested in calculating averages over different periods for different locations. First to make this more realistic, let’s generate ~20 years of data at 2000 locations:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">n_locs &lt;-<span class="st"> </span><span class="dv">2000</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">n_weeks &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">exposure_dataset3 &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">  <span class="kw">lapply</span>(<span class="dv">1</span><span class="op">:</span>n_locs, <span class="cf">function</span>(id) {</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">    <span class="kw">data.table</span>(</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">      <span class="dt">location_id =</span> id,</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">      <span class="dt">start =</span> <span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-01&quot;</span>), <span class="dt">by =</span> <span class="dv">7</span>, <span class="dt">length =</span> n_weeks),</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">      <span class="dt">end =</span> <span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-07&quot;</span>), <span class="dt">by =</span> <span class="dv">7</span>, <span class="dt">length =</span> n_weeks),</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">      <span class="dt">pm25 =</span> <span class="kw">rnorm</span>(n_weeks, <span class="dt">mean =</span> <span class="dv">15</span>),</a>
<a class="sourceLine" id="cb19-10" data-line-number="10">      <span class="dt">no2 =</span> <span class="kw">rnorm</span>(n_weeks, <span class="dt">mean =</span> <span class="dv">25</span>)</a>
<a class="sourceLine" id="cb19-11" data-line-number="11">    )</a>
<a class="sourceLine" id="cb19-12" data-line-number="12">  })</a>
<a class="sourceLine" id="cb19-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb19-14" data-line-number="14"></a>
<a class="sourceLine" id="cb19-15" data-line-number="15">exposure_dataset3</a>
<a class="sourceLine" id="cb19-16" data-line-number="16"><span class="co">#&gt;          location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb19-17" data-line-number="17"><span class="co">#&gt;       1:           1 2000-01-01 2000-01-07 14.63278 26.21289</span></a>
<a class="sourceLine" id="cb19-18" data-line-number="18"><span class="co">#&gt;       2:           1 2000-01-08 2000-01-14 13.95587 24.37274</span></a>
<a class="sourceLine" id="cb19-19" data-line-number="19"><span class="co">#&gt;       3:           1 2000-01-15 2000-01-21 15.56972 26.71116</span></a>
<a class="sourceLine" id="cb19-20" data-line-number="20"><span class="co">#&gt;       4:           1 2000-01-22 2000-01-28 14.86495 24.60563</span></a>
<a class="sourceLine" id="cb19-21" data-line-number="21"><span class="co">#&gt;       5:           1 2000-01-29 2000-02-04 17.40162 22.67851</span></a>
<a class="sourceLine" id="cb19-22" data-line-number="22"><span class="co">#&gt;      ---                                                    </span></a>
<a class="sourceLine" id="cb19-23" data-line-number="23"><span class="co">#&gt; 1999996:        2000 2019-01-26 2019-02-01 15.00646 25.27885</span></a>
<a class="sourceLine" id="cb19-24" data-line-number="24"><span class="co">#&gt; 1999997:        2000 2019-02-02 2019-02-08 16.41525 26.14573</span></a>
<a class="sourceLine" id="cb19-25" data-line-number="25"><span class="co">#&gt; 1999998:        2000 2019-02-09 2019-02-15 15.29644 24.84448</span></a>
<a class="sourceLine" id="cb19-26" data-line-number="26"><span class="co">#&gt; 1999999:        2000 2019-02-16 2019-02-22 15.05604 24.01209</span></a>
<a class="sourceLine" id="cb19-27" data-line-number="27"><span class="co">#&gt; 2000000:        2000 2019-02-23 2019-03-01 17.37829 26.74711</span></a></code></pre></div>
<p>Now let’s pick a different random start and end date for each location’s averaging period. We’ll pick start dates at random and define the end the date as 3 years after each start date, thus creating different three-year intervals for every location.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">averaging_periods3 &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">location_id=</span><span class="dv">1</span><span class="op">:</span>n_locs,</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">                                 <span class="dt">start=</span><span class="kw">sample</span>(</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">                                   <span class="dt">x=</span><span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2000-01-01&quot;</span>),<span class="kw">as.IDate</span>(<span class="st">&quot;2019-12-31&quot;</span>),<span class="dt">by=</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">                                   <span class="dt">size=</span>n_locs</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">                                 )</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">averaging_periods3[,end<span class="op">:</span><span class="er">=</span>start<span class="op">+</span><span class="kw">round</span>(<span class="dv">3</span><span class="op">*</span><span class="fl">365.25</span>)]</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">averaging_periods3</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="co">#&gt;       location_id      start        end</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="co">#&gt;    1:           1 2006-12-11 2009-12-11</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="co">#&gt;    2:           2 2018-02-17 2021-02-17</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="co">#&gt;    3:           3 2019-12-23 2022-12-23</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="co">#&gt;    4:           4 2019-01-08 2022-01-08</span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="co">#&gt;    5:           5 2017-03-16 2020-03-16</span></a>
<a class="sourceLine" id="cb20-15" data-line-number="15"><span class="co">#&gt;   ---                                  </span></a>
<a class="sourceLine" id="cb20-16" data-line-number="16"><span class="co">#&gt; 1996:        1996 2012-09-19 2015-09-20</span></a>
<a class="sourceLine" id="cb20-17" data-line-number="17"><span class="co">#&gt; 1997:        1997 2003-04-09 2006-04-09</span></a>
<a class="sourceLine" id="cb20-18" data-line-number="18"><span class="co">#&gt; 1998:        1998 2001-03-31 2004-03-31</span></a>
<a class="sourceLine" id="cb20-19" data-line-number="19"><span class="co">#&gt; 1999:        1999 2016-12-11 2019-12-12</span></a>
<a class="sourceLine" id="cb20-20" data-line-number="20"><span class="co">#&gt; 2000:        2000 2012-06-11 2015-06-12</span></a></code></pre></div>
<p>Because we’ve already generated <code>y</code> (<code>averaging_period3</code>) to contain the desired averaging interval for each value of the grouping variable <code>location_id</code>, it’s ready to be used as an argument to <code>intervalaverag</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">intervalaverage</span>(exposure_dataset3,</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">                averaging_periods3,</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">                <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">                <span class="dt">group_vars=</span><span class="st">&quot;location_id&quot;</span>)[,<span class="kw">list</span>(location_id,start,end,pm25,no2)]</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="co">#&gt;       location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="co">#&gt;    1:           1 2006-12-11 2009-12-11 14.92398 25.08483</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="co">#&gt;    2:           2 2018-02-17 2021-02-17       NA       NA</span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="co">#&gt;    3:           3 2019-12-23 2022-12-23       NA       NA</span></a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="co">#&gt;    4:           4 2019-01-08 2022-01-08       NA       NA</span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="co">#&gt;    5:           5 2017-03-16 2020-03-16       NA       NA</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="co">#&gt;   ---                                                    </span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13"><span class="co">#&gt; 1996:        1996 2012-09-19 2015-09-20 15.02879 25.05804</span></a>
<a class="sourceLine" id="cb21-14" data-line-number="14"><span class="co">#&gt; 1997:        1997 2003-04-09 2006-04-09 14.88153 24.99050</span></a>
<a class="sourceLine" id="cb21-15" data-line-number="15"><span class="co">#&gt; 1998:        1998 2001-03-31 2004-03-31 15.05534 24.90188</span></a>
<a class="sourceLine" id="cb21-16" data-line-number="16"><span class="co">#&gt; 1999:        1999 2016-12-11 2019-12-12       NA       NA</span></a>
<a class="sourceLine" id="cb21-17" data-line-number="17"><span class="co">#&gt; 2000:        2000 2012-06-11 2015-06-12 15.09675 25.04789</span></a></code></pre></div>
<p>You shouldn’t be surprised to see some missingness since the earliest possible latest possible averaging period start date is Dec 31, 2019 but the exposures stop in early 2019. The <code>required_percentage</code> argument could be set here to something less than the default of 100 to compute partial averages and get fewer missing values.</p>
<p>Finally, a quick trick if you’d like to calculate 1-year, 2-year, and 3-year averages all at once, starting with a fixed set of end dates:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">averaging_periods3[, avg3yr<span class="op">:</span><span class="er">=</span>end<span class="op">-</span><span class="kw">round</span>(<span class="dv">3</span><span class="op">*</span><span class="fl">365.25</span>)]</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">averaging_periods3[, avg2yr<span class="op">:</span><span class="er">=</span>end<span class="op">-</span><span class="kw">round</span>(<span class="dv">2</span><span class="op">*</span><span class="fl">365.25</span>)]</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">averaging_periods3[, avg1yr<span class="op">:</span><span class="er">=</span>end<span class="op">-</span><span class="kw">round</span>(<span class="dv">1</span><span class="op">*</span><span class="fl">365.25</span>)]</a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">#reshape the data.table:</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5">averaging_periods4 &lt;-<span class="st"> </span><span class="kw">melt</span>(averaging_periods3,<span class="dt">id.vars=</span><span class="kw">c</span>(<span class="st">&quot;location_id&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">                           <span class="dt">measure.vars =</span> <span class="kw">c</span>(<span class="st">&quot;avg3yr&quot;</span>,<span class="st">&quot;avg2yr&quot;</span>,<span class="st">&quot;avg1yr&quot;</span>)) </a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="kw">setnames</span>(averaging_periods4, <span class="st">&quot;value&quot;</span>,<span class="st">&quot;start&quot;</span>)</a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="kw">setnames</span>(averaging_periods4, <span class="st">&quot;variable&quot;</span>,<span class="st">&quot;averaging_period&quot;</span>)</a>
<a class="sourceLine" id="cb22-9" data-line-number="9">averaging_periods4</a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="co">#&gt;       location_id        end averaging_period      start</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="co">#&gt;    1:           1 2009-12-11           avg3yr 2006-12-11</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="co">#&gt;    2:           2 2021-02-17           avg3yr 2018-02-17</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="co">#&gt;    3:           3 2022-12-23           avg3yr 2019-12-23</span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14"><span class="co">#&gt;    4:           4 2022-01-08           avg3yr 2019-01-08</span></a>
<a class="sourceLine" id="cb22-15" data-line-number="15"><span class="co">#&gt;    5:           5 2020-03-16           avg3yr 2017-03-16</span></a>
<a class="sourceLine" id="cb22-16" data-line-number="16"><span class="co">#&gt;   ---                                                   </span></a>
<a class="sourceLine" id="cb22-17" data-line-number="17"><span class="co">#&gt; 5996:        1996 2015-09-20           avg1yr 2014-09-20</span></a>
<a class="sourceLine" id="cb22-18" data-line-number="18"><span class="co">#&gt; 5997:        1997 2006-04-09           avg1yr 2005-04-09</span></a>
<a class="sourceLine" id="cb22-19" data-line-number="19"><span class="co">#&gt; 5998:        1998 2004-03-31           avg1yr 2003-04-01</span></a>
<a class="sourceLine" id="cb22-20" data-line-number="20"><span class="co">#&gt; 5999:        1999 2019-12-12           avg1yr 2018-12-12</span></a>
<a class="sourceLine" id="cb22-21" data-line-number="21"><span class="co">#&gt; 6000:        2000 2015-06-12           avg1yr 2014-06-12</span></a></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw">intervalaverage</span>(exposure_dataset3,averaging_periods4,<span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">                <span class="dt">group_vars=</span><span class="kw">c</span>(<span class="st">&quot;location_id&quot;</span>),</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">                <span class="dt">required_percentage =</span> <span class="dv">75</span>)[,<span class="kw">list</span>(location_id,start,end,pm25,no2)]</a>
<a class="sourceLine" id="cb23-6" data-line-number="6"><span class="co">#&gt;       location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="co">#&gt;    1:           1 2006-12-11 2009-12-11 14.92398 25.08483</span></a>
<a class="sourceLine" id="cb23-8" data-line-number="8"><span class="co">#&gt;    2:           1 2007-12-12 2009-12-11 14.96129 25.01816</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9"><span class="co">#&gt;    3:           1 2008-12-11 2009-12-11 14.99041 25.02960</span></a>
<a class="sourceLine" id="cb23-10" data-line-number="10"><span class="co">#&gt;    4:           2 2018-02-17 2021-02-17       NA       NA</span></a>
<a class="sourceLine" id="cb23-11" data-line-number="11"><span class="co">#&gt;    5:           2 2019-02-18 2021-02-17       NA       NA</span></a>
<a class="sourceLine" id="cb23-12" data-line-number="12"><span class="co">#&gt;   ---                                                    </span></a>
<a class="sourceLine" id="cb23-13" data-line-number="13"><span class="co">#&gt; 5996:        1999 2017-12-12 2019-12-12       NA       NA</span></a>
<a class="sourceLine" id="cb23-14" data-line-number="14"><span class="co">#&gt; 5997:        1999 2018-12-12 2019-12-12       NA       NA</span></a>
<a class="sourceLine" id="cb23-15" data-line-number="15"><span class="co">#&gt; 5998:        2000 2012-06-11 2015-06-12 15.09675 25.04789</span></a>
<a class="sourceLine" id="cb23-16" data-line-number="16"><span class="co">#&gt; 5999:        2000 2013-06-12 2015-06-12 15.07803 25.03959</span></a>
<a class="sourceLine" id="cb23-17" data-line-number="17"><span class="co">#&gt; 6000:        2000 2014-06-12 2015-06-12 14.95297 25.14248</span></a></code></pre></div>
</div>
<div id="interval-intersects-averaging-with-an-address-history" class="section level2">
<h2>Interval intersects: averaging with an address history</h2>
<p>So far we’ve fully covered the functionality of the <code>intervalaverage</code> function and how to use it when we want to average over time at specific locations.</p>
<p>The above examples also cover the approach we’d use if we wanted to average over a cohort of study participants for whom we only have a single address (and we are ok assuming that participants never move).</p>
<p>However, in cohort studies, each participants shares their past locations/addresses and indicated the time periods over which they lived at each of those addresses. Typically this information is represented through a table we refer to as an “address history.”</p>
<p>We’ll start with a very simple example to demonstrate what an address history looks like and how we might use this in exposure averaging. Consider the following address history and exposure datasets:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">exposure_dataset5</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="co">#&gt;     addr_id exp_start exp_end  exp_value</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="co">#&gt;  1:       1         1       7  1.3345175</span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="co">#&gt;  2:       1         8      14  1.0233578</span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="co">#&gt;  3:       1        15      21  1.0334900</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6"><span class="co">#&gt;  4:       2         1       7 -1.3967607</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="co">#&gt;  5:       2         8      14  1.2922388</span></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="co">#&gt;  6:       2        15      21 -1.3653823</span></a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="co">#&gt;  7:       3         1       7 -0.9738918</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="co">#&gt;  8:       3         8      14  0.9785869</span></a>
<a class="sourceLine" id="cb24-11" data-line-number="11"><span class="co">#&gt;  9:       3        15      21 -0.2132947</span></a>
<a class="sourceLine" id="cb24-12" data-line-number="12"><span class="co">#&gt; 10:       4         1       7  0.2635925</span></a>
<a class="sourceLine" id="cb24-13" data-line-number="13"><span class="co">#&gt; 11:       4         8      14  0.2779942</span></a>
<a class="sourceLine" id="cb24-14" data-line-number="14"><span class="co">#&gt; 12:       4        15      21 -0.7184920</span></a></code></pre></div>
<p>Note that <code>exposure_dataset5</code> has two regular (length-7) intervals for each address and corresponding measurements for those periods.</p>
<p>Here is a sample address history table:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">address_history0</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="co">#&gt;    addr_id ppt_id addr_start addr_end</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="co">#&gt; 1:       1      1          1        9</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="co">#&gt; 2:       2      1         10       11</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="co">#&gt; 3:       2      1         12       14</span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="co">#&gt; 4:       3      2          1       12</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="co">#&gt; 5:       5      2         13       15</span></a></code></pre></div>
<p>The first thing to note is that the address intervals (<code>addr_start</code> and <code>addr_end</code>) are non-overlapping, which is good because <code>intervalaverage</code> requires non-overlapping intervals as we saw previously. (If the addresses were overlapping we might consider using the <code>isolateoverlaps</code> function on it to identify overlapping periods in the address history and make decisions about which address to use in each overlapping period).</p>
<p>The <code>address_history0</code> table has one participant with three rows and two addresses (<code>addr_id</code>s 1 and 2). In practice this would be the same data if the two intervals where <code>ppt_id==1 &amp; addr_id==2</code> were stored as a single row corresponding to the interval <code>[10,14]</code>, but the dataset has been created like this to demonstrate that a single address represented over non-overlapping intervals doesn’t cause problems. The second participant also has two addresses (<code>addr_ids</code>s 3 and 5).</p>
<p>The goal here is to get exposures merged and clipped to the address intervals, but the problem is that the address intervals don’t line up nicely with the exposure intervals. Participant 1 lived add address 1 from <code>[1,9]</code> but exposure is measured over <code>[1,7]</code> and <code>[8,14]</code>. The solution is to create two rows for that participant, one row for <code>[1,7]</code> and a second row from <code>[8,9]</code>. This can be accomplished using the <code>intervalintersect</code> function:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">exposure_addresss_table &lt;-<span class="st"> </span><span class="kw">intervalintersect</span>(exposure_dataset5,</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">                                             address_history0,</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">                                             <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="dt">exp_start=</span><span class="st">&quot;addr_start&quot;</span>,</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">                                                             <span class="dt">exp_end=</span><span class="st">&quot;addr_end&quot;</span>),</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">                                             <span class="st">&quot;addr_id&quot;</span>)</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">exposure_addresss_table</a>
<a class="sourceLine" id="cb26-8" data-line-number="8"><span class="co">#&gt;    addr_id start end  exp_value ppt_id</span></a>
<a class="sourceLine" id="cb26-9" data-line-number="9"><span class="co">#&gt; 1:       1     1   7  1.3345175      1</span></a>
<a class="sourceLine" id="cb26-10" data-line-number="10"><span class="co">#&gt; 2:       1     8   9  1.0233578      1</span></a>
<a class="sourceLine" id="cb26-11" data-line-number="11"><span class="co">#&gt; 3:       2    10  11  1.2922388      1</span></a>
<a class="sourceLine" id="cb26-12" data-line-number="12"><span class="co">#&gt; 4:       2    12  14  1.2922388      1</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="co">#&gt; 5:       3     1   7 -0.9738918      2</span></a>
<a class="sourceLine" id="cb26-14" data-line-number="14"><span class="co">#&gt; 6:       3     8  12  0.9785869      2</span></a></code></pre></div>
<p><code>intervalintersect</code> takes every possible combination of overlapping intervals within <code>group_vars</code> (in this sense it is a cartesian join. More on this below).</p>
<p><code>intervalintersect</code> is also an inner join because rows from either table that are not joined are not included in the output. For example, rows where <code>addr_id==4</code> in <code>exposure_dataset5</code> is not included since there are no rows in <code>address_history0</code> where <code>addr_id==4</code>. Additionally, none of the exposure periods from <code>exposure_dataset5</code> measured over <code>exposure_start==15</code> to <code>exposure_start==21</code> are included in the result, because none of the address history intervals overlap with those periods. Finally, there is an address (<code>addr_id==5</code> from <code>ppt_id==2</code>) in the <code>addr_history</code> table that isn’t in the <code>exposure_dataset5</code> table. This address is also excluded from the result since exposure estimates do not exist for that participant.</p>
<p>It’s worth doing some checks after completion of the intersection to identify what information has been dropped by the inner join:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">setdiff</span>(address_history0<span class="op">$</span>addr_id,exposure_addresss_table<span class="op">$</span>addr_id)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="co">#&gt; [1] 5</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw">setdiff</span>(exposure_dataset5<span class="op">$</span>addr_id,exposure_addresss_table<span class="op">$</span>addr_id)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="co">#&gt; [1] 4</span></a></code></pre></div>
<p>Finally, note that the syntax of <code>interval_vars</code> allows those columns to be named differently in <code>x</code> and <code>y</code> via a named vector: <code>interval_vars=c(exposure_start=&quot;addr_start&quot;,exposure_end=&quot;addr_end&quot;)</code>. This is useful for keeping track of interval names since the return data.table has three sets of intervals: those from <code>x</code>, those from <code>y</code>, and their intersections.</p>
<div id="interval-intersects-averaging-with-a-larger-address-history" class="section level3">
<h3>Interval intersects: averaging with a larger address history</h3>
<p>starting with the unique set of locations extracted from <code>exposure_dataset3</code>, let’s generate 300 participants and a random number of addresses each participant lived at</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">n_ppt &lt;-<span class="st"> </span><span class="dv">300</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2">addr_history &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">ppt_id=</span><span class="kw">paste0</span>(<span class="st">&quot;ppt&quot;</span>,<span class="kw">sprintf</span>(<span class="st">&quot;%03d&quot;</span>, <span class="dv">1</span><span class="op">:</span>n_ppt)))</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">addr_history[, n_addr <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">rbinom</span>(.N,<span class="dt">size=</span><span class="kw">length</span>(<span class="kw">unique</span>(exposure_dataset3<span class="op">$</span>location_id)),<span class="dt">prob=</span>.<span class="dv">001</span>)]</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">addr_history[n_addr <span class="op">&lt;</span>1L, n_addr <span class="op">:</span><span class="er">=</span><span class="st"> </span>1L] </a>
<a class="sourceLine" id="cb28-5" data-line-number="5"></a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="co">#repl=TRUE because it's possible for an address to be lived at multiple different time intervals:</span></a>
<a class="sourceLine" id="cb28-7" data-line-number="7">addr_history &lt;-<span class="st"> </span>addr_history[, </a>
<a class="sourceLine" id="cb28-8" data-line-number="8">                             <span class="kw">list</span>(<span class="dt">location_id=</span><span class="kw">sample</span>(exposure_dataset3<span class="op">$</span>location_id,n_addr,<span class="dt">replace=</span><span class="ot">TRUE</span>)),</a>
<a class="sourceLine" id="cb28-9" data-line-number="9">                             by=<span class="st">&quot;ppt_id&quot;</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10">                             ]   </a>
<a class="sourceLine" id="cb28-11" data-line-number="11">addr_history</a>
<a class="sourceLine" id="cb28-12" data-line-number="12"><span class="co">#&gt;      ppt_id location_id</span></a>
<a class="sourceLine" id="cb28-13" data-line-number="13"><span class="co">#&gt;   1: ppt001        1793</span></a>
<a class="sourceLine" id="cb28-14" data-line-number="14"><span class="co">#&gt;   2: ppt001         337</span></a>
<a class="sourceLine" id="cb28-15" data-line-number="15"><span class="co">#&gt;   3: ppt002        1492</span></a>
<a class="sourceLine" id="cb28-16" data-line-number="16"><span class="co">#&gt;   4: ppt002        1943</span></a>
<a class="sourceLine" id="cb28-17" data-line-number="17"><span class="co">#&gt;   5: ppt002        1853</span></a>
<a class="sourceLine" id="cb28-18" data-line-number="18"><span class="co">#&gt;  ---                   </span></a>
<a class="sourceLine" id="cb28-19" data-line-number="19"><span class="co">#&gt; 616: ppt299        1047</span></a>
<a class="sourceLine" id="cb28-20" data-line-number="20"><span class="co">#&gt; 617: ppt299         878</span></a>
<a class="sourceLine" id="cb28-21" data-line-number="21"><span class="co">#&gt; 618: ppt300        1228</span></a>
<a class="sourceLine" id="cb28-22" data-line-number="22"><span class="co">#&gt; 619: ppt300        1194</span></a>
<a class="sourceLine" id="cb28-23" data-line-number="23"><span class="co">#&gt; 620: ppt300         241</span></a>
<a class="sourceLine" id="cb28-24" data-line-number="24"></a>
<a class="sourceLine" id="cb28-25" data-line-number="25"><span class="co">#note that not all of these 2000 locations in exposure_dataset3 were &quot;lived at&quot; in this cohort:</span></a>
<a class="sourceLine" id="cb28-26" data-line-number="26"><span class="kw">length</span>(<span class="kw">unique</span>(addr_history<span class="op">$</span>location_id)) </a>
<a class="sourceLine" id="cb28-27" data-line-number="27"><span class="co">#&gt; [1] 535</span></a>
<a class="sourceLine" id="cb28-28" data-line-number="28"></a>
<a class="sourceLine" id="cb28-29" data-line-number="29"><span class="co">#also note that it's possible for different participants to live at the same address.</span></a>
<a class="sourceLine" id="cb28-30" data-line-number="30">addr_history[,<span class="kw">list</span>(<span class="dt">loc_with_more_than_one_ppt=</span><span class="kw">length</span>(<span class="kw">unique</span>(ppt_id))<span class="op">&gt;</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb28-31" data-line-number="31">             by=location_id][,</a>
<a class="sourceLine" id="cb28-32" data-line-number="32">                             <span class="kw">sum</span>(loc_with_more_than_one_ppt)]</a>
<a class="sourceLine" id="cb28-33" data-line-number="33"><span class="co">#&gt; [1] 77</span></a>
<a class="sourceLine" id="cb28-34" data-line-number="34"><span class="co">#Because of the way I generated this data, it's way more common than you'd expect in a real cohort </span></a>
<a class="sourceLine" id="cb28-35" data-line-number="35"><span class="co">#but it does happen especially in cohorts with familial recruitment or people living in nursing home complexes.</span></a></code></pre></div>
<p>I’ve generated intervals which are non-overlapping representing the participant address history (the code to achieve this is hidden because it’s complicated and not the point of this vignette):</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">addr_history</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="co">#&gt;      ppt_id location_id addr_start   addr_end  addr_id</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="co">#&gt;   1: ppt001        1793 1961-04-01 1986-07-03 ppt001_2</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="co">#&gt;   2: ppt001         337 1989-06-14 9999-01-01 ppt001_1</span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="co">#&gt;   3: ppt002        1492 1970-07-01 1978-04-12 ppt002_2</span></a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="co">#&gt;   4: ppt002        1943 1980-07-02 1981-12-07 ppt002_4</span></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="co">#&gt;   5: ppt002        1853 1984-07-10 1990-08-19 ppt002_3</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8"><span class="co">#&gt;  ---                                                  </span></a>
<a class="sourceLine" id="cb29-9" data-line-number="9"><span class="co">#&gt; 616: ppt299        1047 1974-06-28 1983-01-04 ppt299_2</span></a>
<a class="sourceLine" id="cb29-10" data-line-number="10"><span class="co">#&gt; 617: ppt299         878 1988-08-05 9999-01-01 ppt299_1</span></a>
<a class="sourceLine" id="cb29-11" data-line-number="11"><span class="co">#&gt; 618: ppt300        1228 1972-09-01 1975-04-17 ppt300_3</span></a>
<a class="sourceLine" id="cb29-12" data-line-number="12"><span class="co">#&gt; 619: ppt300        1194 1975-08-27 1989-11-11 ppt300_2</span></a>
<a class="sourceLine" id="cb29-13" data-line-number="13"><span class="co">#&gt; 620: ppt300         241 2004-06-20 9999-01-01 ppt300_1</span></a></code></pre></div>
<p>Oftentimes participant addresses are given their own keys that are distinct from location_id and that’s represented in the above table. This means that a single <code>location_id</code> may map to multiple <code>addr_ids</code>.</p>
<p>It’s important for these address tables to be non-overlapping within ppt. As shown previously, there’s a function in the <code>intervalaverage</code> package for that check:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">is.overlapping</span>(addr_history,<span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;addr_start&quot;</span>,<span class="st">&quot;addr_end&quot;</span>),</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">               <span class="dt">group_vars=</span><span class="st">&quot;ppt_id&quot;</span>) <span class="co">#FALSE is good--it means there's no overlap of dates within ppt.</span></a>
<a class="sourceLine" id="cb30-3" data-line-number="3"><span class="co">#&gt; [1] FALSE</span></a></code></pre></div>
<p>This table passes that check because I’ve generated the data to be non-overlapping, but often times people report overlapping address histories and analytic decisions need to be made to de-overlap them (again, the <code>isolateoverlap</code> function would be useful for isolating sections of overlapping address intervals).</p>
</div>
<div id="interval-intersects-is-a-cartesian-join" class="section level3">
<h3>interval intersects is a cartesian join</h3>
<p>So far we’ve seen exposure datasets stored by <code>location_id</code> but it’s possible also to store exposures stored by <code>addr_id</code> (such that the series of exposure estimates for a single locations may be repeated multiple time if that <code>location_id</code> maps to multiple <code>addr_id</code>s )</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">exposure_dataset3_addr &lt;-<span class="st"> </span><span class="kw">unique</span>(addr_history[, <span class="kw">list</span>(location_id,addr_id)])[exposure_dataset3, </a>
<a class="sourceLine" id="cb31-2" data-line-number="2">                                                                            on=<span class="kw">c</span>(<span class="st">&quot;location_id&quot;</span>),</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">                                                                            allow.cartesian=<span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">                                                                            nomatch=<span class="ot">NULL</span>]</a>
<a class="sourceLine" id="cb31-5" data-line-number="5">exposure_dataset3</a>
<a class="sourceLine" id="cb31-6" data-line-number="6"><span class="co">#&gt;          location_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7"><span class="co">#&gt;       1:           1 2000-01-01 2000-01-07 14.63278 26.21289</span></a>
<a class="sourceLine" id="cb31-8" data-line-number="8"><span class="co">#&gt;       2:           1 2000-01-08 2000-01-14 13.95587 24.37274</span></a>
<a class="sourceLine" id="cb31-9" data-line-number="9"><span class="co">#&gt;       3:           1 2000-01-15 2000-01-21 15.56972 26.71116</span></a>
<a class="sourceLine" id="cb31-10" data-line-number="10"><span class="co">#&gt;       4:           1 2000-01-22 2000-01-28 14.86495 24.60563</span></a>
<a class="sourceLine" id="cb31-11" data-line-number="11"><span class="co">#&gt;       5:           1 2000-01-29 2000-02-04 17.40162 22.67851</span></a>
<a class="sourceLine" id="cb31-12" data-line-number="12"><span class="co">#&gt;      ---                                                    </span></a>
<a class="sourceLine" id="cb31-13" data-line-number="13"><span class="co">#&gt; 1999996:        2000 2019-01-26 2019-02-01 15.00646 25.27885</span></a>
<a class="sourceLine" id="cb31-14" data-line-number="14"><span class="co">#&gt; 1999997:        2000 2019-02-02 2019-02-08 16.41525 26.14573</span></a>
<a class="sourceLine" id="cb31-15" data-line-number="15"><span class="co">#&gt; 1999998:        2000 2019-02-09 2019-02-15 15.29644 24.84448</span></a>
<a class="sourceLine" id="cb31-16" data-line-number="16"><span class="co">#&gt; 1999999:        2000 2019-02-16 2019-02-22 15.05604 24.01209</span></a>
<a class="sourceLine" id="cb31-17" data-line-number="17"><span class="co">#&gt; 2000000:        2000 2019-02-23 2019-03-01 17.37829 26.74711</span></a>
<a class="sourceLine" id="cb31-18" data-line-number="18">exposure_dataset3_addr</a>
<a class="sourceLine" id="cb31-19" data-line-number="19"><span class="co">#&gt;         location_id  addr_id      start        end     pm25      no2</span></a>
<a class="sourceLine" id="cb31-20" data-line-number="20"><span class="co">#&gt;      1:           1 ppt105_1 2000-01-01 2000-01-07 14.63278 26.21289</span></a>
<a class="sourceLine" id="cb31-21" data-line-number="21"><span class="co">#&gt;      2:           1 ppt105_1 2000-01-08 2000-01-14 13.95587 24.37274</span></a>
<a class="sourceLine" id="cb31-22" data-line-number="22"><span class="co">#&gt;      3:           1 ppt105_1 2000-01-15 2000-01-21 15.56972 26.71116</span></a>
<a class="sourceLine" id="cb31-23" data-line-number="23"><span class="co">#&gt;      4:           1 ppt105_1 2000-01-22 2000-01-28 14.86495 24.60563</span></a>
<a class="sourceLine" id="cb31-24" data-line-number="24"><span class="co">#&gt;      5:           1 ppt105_1 2000-01-29 2000-02-04 17.40162 22.67851</span></a>
<a class="sourceLine" id="cb31-25" data-line-number="25"><span class="co">#&gt;     ---                                                             </span></a>
<a class="sourceLine" id="cb31-26" data-line-number="26"><span class="co">#&gt; 619996:        1997 ppt150_1 2019-02-09 2019-02-15 14.45723 25.47479</span></a>
<a class="sourceLine" id="cb31-27" data-line-number="27"><span class="co">#&gt; 619997:        1997 ppt054_2 2019-02-16 2019-02-22 14.05648 26.26435</span></a>
<a class="sourceLine" id="cb31-28" data-line-number="28"><span class="co">#&gt; 619998:        1997 ppt150_1 2019-02-16 2019-02-22 14.05648 26.26435</span></a>
<a class="sourceLine" id="cb31-29" data-line-number="29"><span class="co">#&gt; 619999:        1997 ppt054_2 2019-02-23 2019-03-01 15.54294 22.57325</span></a>
<a class="sourceLine" id="cb31-30" data-line-number="30"><span class="co">#&gt; 620000:        1997 ppt150_1 2019-02-23 2019-03-01 15.54294 22.57325</span></a></code></pre></div>
<p>Note that <code>exposure_dataset3_addr</code> contains repeat locations whereas <code>exposure_dataset3</code> contains exactly one location per time point:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">exposure_dataset3[, <span class="kw">sum</span>(<span class="kw">duplicated</span>(location_id)),by=<span class="kw">c</span>(<span class="st">&quot;start&quot;</span>)][,<span class="kw">max</span>(V1)] <span class="co">#no duplicate locations at any date</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="co">#&gt; [1] 0</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3">exposure_dataset3_addr[, <span class="kw">sum</span>(<span class="kw">duplicated</span>(location_id)),by=<span class="kw">c</span>(<span class="st">&quot;start&quot;</span>)][,<span class="kw">max</span>(V1)] </a>
<a class="sourceLine" id="cb32-4" data-line-number="4"><span class="co">#&gt; [1] 85</span></a></code></pre></div>
<p><code>exposure_dataset3_addr</code> has duplicate locations since multiple ppts may live at the same location or because a single participant lives at the same location multiple times.</p>
<p>(Storing exposure data according to <code>addr_id</code> rather than <code>location_id</code> takes up more space but may be beneficial for constraining exposure model revisions to be the same within cohorts)</p>
<p><code>location_id</code> may not even be present in the address table if it’s stored by address_id:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">exposure_dataset3_addr[, location_id<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]</a></code></pre></div>
<p>Even if this distinction between how exposures are stored doesn’t seem relevant, this section will demonstrate how <code>intervalintersect</code> is actually a cartesian join (in addition to being an inner interval join).</p>
<p>Whether the exposure dataset is stored by address or location, the <code>intervalintersect</code> will result in values from the exposure dataset merged to every address. In the case of the exposure table being stored by <code>addr_id</code>, this is a simple one to one merge (since for every address in the address history there’s a set of exposures in the exposure table).</p>
<p>But in the case of the exposure table being stored by <code>location_id</code>, this becomes a one to many merge (since a single location id may merge to multiple locations in the address history table).</p>
<p>This works because the function that <code>intervalintersect</code> relies on (<code>data.table::foverlaps</code>) is performing an inner cartesian merge: that is–it only takes rows which match on the keying variables but also does a cartesian expansion if there are multiple matches in both tables.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">z &lt;-<span class="st"> </span><span class="kw">intervalintersect</span>(<span class="dt">x=</span>exposure_dataset3,</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">               <span class="dt">y=</span>addr_history,</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">               <span class="dt">interval_vars=</span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb34-4" data-line-number="4">                 <span class="dt">start=</span><span class="st">&quot;addr_start&quot;</span>,</a>
<a class="sourceLine" id="cb34-5" data-line-number="5">                 <span class="dt">end=</span><span class="st">&quot;addr_end&quot;</span></a>
<a class="sourceLine" id="cb34-6" data-line-number="6">                 ),</a>
<a class="sourceLine" id="cb34-7" data-line-number="7">               <span class="dt">group_vars=</span><span class="kw">c</span>(<span class="st">&quot;location_id&quot;</span>),</a>
<a class="sourceLine" id="cb34-8" data-line-number="8">               <span class="dt">interval_vars_out=</span><span class="kw">c</span>(<span class="st">&quot;start2&quot;</span>,<span class="st">&quot;end2&quot;</span>)</a>
<a class="sourceLine" id="cb34-9" data-line-number="9">) </a>
<a class="sourceLine" id="cb34-10" data-line-number="10"></a>
<a class="sourceLine" id="cb34-11" data-line-number="11">z_addr &lt;-<span class="st"> </span><span class="kw">intervalintersect</span>(<span class="dt">x=</span>exposure_dataset3_addr,</a>
<a class="sourceLine" id="cb34-12" data-line-number="12">               <span class="dt">y=</span>addr_history,</a>
<a class="sourceLine" id="cb34-13" data-line-number="13">               <span class="dt">interval_vars=</span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb34-14" data-line-number="14">                 <span class="dt">start=</span><span class="st">&quot;addr_start&quot;</span>,</a>
<a class="sourceLine" id="cb34-15" data-line-number="15">                 <span class="dt">end=</span><span class="st">&quot;addr_end&quot;</span></a>
<a class="sourceLine" id="cb34-16" data-line-number="16">                 ),</a>
<a class="sourceLine" id="cb34-17" data-line-number="17">               <span class="dt">group_vars=</span><span class="kw">c</span>(<span class="st">&quot;addr_id&quot;</span>),</a>
<a class="sourceLine" id="cb34-18" data-line-number="18">               <span class="dt">interval_vars_out=</span><span class="kw">c</span>(<span class="st">&quot;start2&quot;</span>,<span class="st">&quot;end2&quot;</span>)</a>
<a class="sourceLine" id="cb34-19" data-line-number="19">) </a>
<a class="sourceLine" id="cb34-20" data-line-number="20"></a>
<a class="sourceLine" id="cb34-21" data-line-number="21"><span class="kw">setkey</span>(z,ppt_id,start2,end2)</a>
<a class="sourceLine" id="cb34-22" data-line-number="22"><span class="kw">setkey</span>(z_addr,ppt_id,start2,end2)</a>
<a class="sourceLine" id="cb34-23" data-line-number="23"><span class="kw">all.equal</span>(z,z_addr)</a>
<a class="sourceLine" id="cb34-24" data-line-number="24"><span class="co">#&gt; [1] &quot;Different column order&quot;</span></a>
<a class="sourceLine" id="cb34-25" data-line-number="25"></a>
<a class="sourceLine" id="cb34-26" data-line-number="26">z</a>
<a class="sourceLine" id="cb34-27" data-line-number="27"><span class="co">#&gt;         location_id     start2       end2     pm25      no2 ppt_id</span></a>
<a class="sourceLine" id="cb34-28" data-line-number="28"><span class="co">#&gt;      1:         337 2000-01-01 2000-01-07 15.15344 26.26791 ppt001</span></a>
<a class="sourceLine" id="cb34-29" data-line-number="29"><span class="co">#&gt;      2:         337 2000-01-08 2000-01-14 13.68185 23.93172 ppt001</span></a>
<a class="sourceLine" id="cb34-30" data-line-number="30"><span class="co">#&gt;      3:         337 2000-01-15 2000-01-21 13.06989 24.23879 ppt001</span></a>
<a class="sourceLine" id="cb34-31" data-line-number="31"><span class="co">#&gt;      4:         337 2000-01-22 2000-01-28 15.90837 26.32763 ppt001</span></a>
<a class="sourceLine" id="cb34-32" data-line-number="32"><span class="co">#&gt;      5:         337 2000-01-29 2000-02-04 15.50739 24.37651 ppt001</span></a>
<a class="sourceLine" id="cb34-33" data-line-number="33"><span class="co">#&gt;     ---                                                           </span></a>
<a class="sourceLine" id="cb34-34" data-line-number="34"><span class="co">#&gt; 264965:         241 2019-01-26 2019-02-01 14.57620 25.32593 ppt300</span></a>
<a class="sourceLine" id="cb34-35" data-line-number="35"><span class="co">#&gt; 264966:         241 2019-02-02 2019-02-08 14.78497 26.70319 ppt300</span></a>
<a class="sourceLine" id="cb34-36" data-line-number="36"><span class="co">#&gt; 264967:         241 2019-02-09 2019-02-15 14.55443 24.04428 ppt300</span></a>
<a class="sourceLine" id="cb34-37" data-line-number="37"><span class="co">#&gt; 264968:         241 2019-02-16 2019-02-22 14.07411 26.19916 ppt300</span></a>
<a class="sourceLine" id="cb34-38" data-line-number="38"><span class="co">#&gt; 264969:         241 2019-02-23 2019-03-01 13.29841 25.35809 ppt300</span></a>
<a class="sourceLine" id="cb34-39" data-line-number="39"><span class="co">#&gt;          addr_id</span></a>
<a class="sourceLine" id="cb34-40" data-line-number="40"><span class="co">#&gt;      1: ppt001_1</span></a>
<a class="sourceLine" id="cb34-41" data-line-number="41"><span class="co">#&gt;      2: ppt001_1</span></a>
<a class="sourceLine" id="cb34-42" data-line-number="42"><span class="co">#&gt;      3: ppt001_1</span></a>
<a class="sourceLine" id="cb34-43" data-line-number="43"><span class="co">#&gt;      4: ppt001_1</span></a>
<a class="sourceLine" id="cb34-44" data-line-number="44"><span class="co">#&gt;      5: ppt001_1</span></a>
<a class="sourceLine" id="cb34-45" data-line-number="45"><span class="co">#&gt;     ---         </span></a>
<a class="sourceLine" id="cb34-46" data-line-number="46"><span class="co">#&gt; 264965: ppt300_1</span></a>
<a class="sourceLine" id="cb34-47" data-line-number="47"><span class="co">#&gt; 264966: ppt300_1</span></a>
<a class="sourceLine" id="cb34-48" data-line-number="48"><span class="co">#&gt; 264967: ppt300_1</span></a>
<a class="sourceLine" id="cb34-49" data-line-number="49"><span class="co">#&gt; 264968: ppt300_1</span></a>
<a class="sourceLine" id="cb34-50" data-line-number="50"><span class="co">#&gt; 264969: ppt300_1</span></a></code></pre></div>
<p>(note that this example of a one to many join maybe isn’t a true “cartesian” join, but intervalintersect is capable of doing a true many-to-many cartesian expansion if provided the right datasets, although I’m not sure in context that would actually make any sense.)</p>
<p>In any case, the morale here is that whether the exposures are stored by location or address, using <code>intervalintersect</code> in combination will result in a dataset containing relevant exposures clipped to each address period.</p>
<p>This dataset can then be used to calculate averages over where a participant lived in a given period:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">final_averaging_periods &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">ppt_id=</span><span class="kw">sort</span>(<span class="kw">unique</span>(addr_history<span class="op">$</span>ppt_id)))</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">final_averaging_periods[, end2<span class="op">:</span><span class="er">=</span><span class="kw">sample</span>(<span class="kw">seq</span>(<span class="kw">as.IDate</span>(<span class="st">&quot;2003-01-01&quot;</span>),<span class="kw">as.IDate</span>(<span class="st">&quot;2015-01-01&quot;</span>),<span class="dt">by=</span><span class="dv">1</span>),.N)]</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">final_averaging_periods[,start2<span class="op">:</span><span class="er">=</span><span class="kw">as.IDate</span>(<span class="kw">floor</span>(<span class="kw">as.numeric</span>(end2<span class="dv">-3</span><span class="op">*</span><span class="fl">365.25</span>)))]</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">final_averaging_periods</a>
<a class="sourceLine" id="cb35-6" data-line-number="6"><span class="co">#&gt;      ppt_id       end2     start2</span></a>
<a class="sourceLine" id="cb35-7" data-line-number="7"><span class="co">#&gt;   1: ppt001 2011-12-22 2008-12-21</span></a>
<a class="sourceLine" id="cb35-8" data-line-number="8"><span class="co">#&gt;   2: ppt002 2004-12-28 2001-12-28</span></a>
<a class="sourceLine" id="cb35-9" data-line-number="9"><span class="co">#&gt;   3: ppt003 2008-02-24 2005-02-23</span></a>
<a class="sourceLine" id="cb35-10" data-line-number="10"><span class="co">#&gt;   4: ppt004 2010-09-17 2007-09-17</span></a>
<a class="sourceLine" id="cb35-11" data-line-number="11"><span class="co">#&gt;   5: ppt005 2010-03-18 2007-03-18</span></a>
<a class="sourceLine" id="cb35-12" data-line-number="12"><span class="co">#&gt;  ---                             </span></a>
<a class="sourceLine" id="cb35-13" data-line-number="13"><span class="co">#&gt; 296: ppt296 2013-01-14 2010-01-14</span></a>
<a class="sourceLine" id="cb35-14" data-line-number="14"><span class="co">#&gt; 297: ppt297 2004-05-14 2001-05-14</span></a>
<a class="sourceLine" id="cb35-15" data-line-number="15"><span class="co">#&gt; 298: ppt298 2009-10-27 2006-10-27</span></a>
<a class="sourceLine" id="cb35-16" data-line-number="16"><span class="co">#&gt; 299: ppt299 2004-08-07 2001-08-07</span></a>
<a class="sourceLine" id="cb35-17" data-line-number="17"><span class="co">#&gt; 300: ppt300 2006-05-14 2003-05-14</span></a>
<a class="sourceLine" id="cb35-18" data-line-number="18"></a>
<a class="sourceLine" id="cb35-19" data-line-number="19"><span class="kw">intervalaverage</span>(z,final_averaging_periods, <span class="dt">interval_vars=</span><span class="kw">c</span>(<span class="st">&quot;start2&quot;</span>,<span class="st">&quot;end2&quot;</span>),</a>
<a class="sourceLine" id="cb35-20" data-line-number="20">                <span class="dt">value_vars=</span><span class="kw">c</span>(<span class="st">&quot;pm25&quot;</span>,<span class="st">&quot;no2&quot;</span>),<span class="dt">group_vars=</span><span class="st">&quot;ppt_id&quot;</span>,<span class="dt">required_percentage =</span> <span class="dv">95</span></a>
<a class="sourceLine" id="cb35-21" data-line-number="21">                )</a>
<a class="sourceLine" id="cb35-22" data-line-number="22"><span class="co">#&gt;      ppt_id     start2       end2     pm25      no2 yduration xduration</span></a>
<a class="sourceLine" id="cb35-23" data-line-number="23"><span class="co">#&gt;   1: ppt001 2008-12-21 2011-12-22 15.10230 24.95967      1097      1097</span></a>
<a class="sourceLine" id="cb35-24" data-line-number="24"><span class="co">#&gt;   2: ppt002 2001-12-28 2004-12-28 14.95920 24.96800      1097      1097</span></a>
<a class="sourceLine" id="cb35-25" data-line-number="25"><span class="co">#&gt;   3: ppt003 2005-02-23 2008-02-24 14.87310 25.03825      1097      1097</span></a>
<a class="sourceLine" id="cb35-26" data-line-number="26"><span class="co">#&gt;   4: ppt004 2007-09-17 2010-09-17 14.92221 24.96349      1097      1097</span></a>
<a class="sourceLine" id="cb35-27" data-line-number="27"><span class="co">#&gt;   5: ppt005 2007-03-18 2010-03-18 14.97623 24.93725      1097      1097</span></a>
<a class="sourceLine" id="cb35-28" data-line-number="28"><span class="co">#&gt;  ---                                                                   </span></a>
<a class="sourceLine" id="cb35-29" data-line-number="29"><span class="co">#&gt; 296: ppt296 2010-01-14 2013-01-14       NA       NA      1097         0</span></a>
<a class="sourceLine" id="cb35-30" data-line-number="30"><span class="co">#&gt; 297: ppt297 2001-05-14 2004-05-14 15.09852 24.93369      1097      1097</span></a>
<a class="sourceLine" id="cb35-31" data-line-number="31"><span class="co">#&gt; 298: ppt298 2006-10-27 2009-10-27       NA       NA      1097       552</span></a>
<a class="sourceLine" id="cb35-32" data-line-number="32"><span class="co">#&gt; 299: ppt299 2001-08-07 2004-08-07 15.11682 25.05562      1097      1097</span></a>
<a class="sourceLine" id="cb35-33" data-line-number="33"><span class="co">#&gt; 300: ppt300 2003-05-14 2006-05-14       NA       NA      1097       694</span></a>
<a class="sourceLine" id="cb35-34" data-line-number="34"><span class="co">#&gt;      nobs_pm25 nobs_no2  xminstart    xmaxend</span></a>
<a class="sourceLine" id="cb35-35" data-line-number="35"><span class="co">#&gt;   1:      1097     1097 2008-12-21 2011-12-22</span></a>
<a class="sourceLine" id="cb35-36" data-line-number="36"><span class="co">#&gt;   2:      1097     1097 2001-12-28 2004-12-28</span></a>
<a class="sourceLine" id="cb35-37" data-line-number="37"><span class="co">#&gt;   3:      1097     1097 2005-02-23 2008-02-24</span></a>
<a class="sourceLine" id="cb35-38" data-line-number="38"><span class="co">#&gt;   4:      1097     1097 2007-09-17 2010-09-17</span></a>
<a class="sourceLine" id="cb35-39" data-line-number="39"><span class="co">#&gt;   5:      1097     1097 2007-03-18 2010-03-18</span></a>
<a class="sourceLine" id="cb35-40" data-line-number="40"><span class="co">#&gt;  ---                                         </span></a>
<a class="sourceLine" id="cb35-41" data-line-number="41"><span class="co">#&gt; 296:         0        0       &lt;NA&gt;       &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb35-42" data-line-number="42"><span class="co">#&gt; 297:      1097     1097 2001-05-14 2004-05-14</span></a>
<a class="sourceLine" id="cb35-43" data-line-number="43"><span class="co">#&gt; 298:       552      552 2008-04-24 2009-10-27</span></a>
<a class="sourceLine" id="cb35-44" data-line-number="44"><span class="co">#&gt; 299:      1097     1097 2001-08-07 2004-08-07</span></a>
<a class="sourceLine" id="cb35-45" data-line-number="45"><span class="co">#&gt; 300:       694      694 2004-06-20 2006-05-14</span></a></code></pre></div>
<p>There’s lots of missingness because the address history I generated is nowhere near complete, but this demonstrates how important it is to have a good address history!</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
