<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Paul Staab" />


<title>Adding Summary Statistics and Simulators</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Adding Summary Statistics and Simulators</h1>
<h4 class="author">Paul Staab</h4>
<h4 class="date">coala 0.6.0</h4>



<p>Coala uses a modular system based on <a href="https://cran.r-project.org/package=R6">R6 Classes</a> for integrating summary statistics and coalescent simulators. This document contains instructions on adding both.</p>
<div id="summary-statistics" class="section level2">
<h2>Summary Statistics</h2>
<p>Summary statistics are derived from the <code>sumstat_class</code> base class. They primarily consist of a <code>calculate</code> function that – well – calculates the statistics value from the simulation results. A simple example is the <code>sumstat_seg_sites()</code> statistic:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(R6)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(coala)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">stat_segsites_class &lt;-<span class="st"> </span><span class="kw">R6Class</span>(<span class="st">&quot;stat_segsites&quot;</span>, <span class="dt">inherit =</span> sumstat_class,</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="dt">private =</span> <span class="kw">list</span>(<span class="dt">req_segsites =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="dt">public =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="dt">calculate =</span> <span class="cf">function</span>(segsites, trees, files, model, sim_task) segsites</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  )</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">sumstat_seg_sites &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="st">&quot;seg_sites&quot;</span>, <span class="dt">transformation =</span> identity) {</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  stat_segsites_class<span class="op">$</span><span class="kw">new</span>(name, transformation)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">}</a></code></pre></div>
<p>The calculate is called after the simulation with the following arguments:</p>
<ul>
<li>First, a list of segregating sites, where each entry of the list contains the segregating sites of a locus.</li>
<li>Second, a list of trees currently in Newick format.</li>
<li>Third, the raw output files from the simulator.</li>
<li>Finally, the model that was simulated.</li>
</ul>
<p>Among the above mentioned parameters, model is always passed to the calculate function. The other three input parameters are generated on demand and have to be requested by the statistic. To do so, set the private variables <code>req_segsites</code>, <code>req_trees</code> or <code>req_files</code>, respectively, to <code>TRUE</code>. Arguments not requested can be present if they are created for a different summary statistic, but will be <code>NULL</code> in most cases.</p>
<p>In this example we only use the segregating sites, and hence it is the only argument request. All that the summary statistic does is to return the unmodified segregating sites.</p>
<p>Warning: I am currently only satisfied with the structure of the segregating sites. The format of the <code>trees</code> and the <code>files</code> arguments might still change.</p>
<div id="adding-a-constructor" class="section level3">
<h3>Adding A Constructor</h3>
<p>If the statistic has additional options that can be set on creation, overwrite the <code>initialize</code> function. Take, for example, a simplified version of <code>sumstat_file</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">stat_file_class &lt;-<span class="st"> </span><span class="kw">R6Class</span>(<span class="st">&quot;stat_file&quot;</span>, <span class="dt">inherit =</span> sumstat_class,</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="dt">private =</span> <span class="kw">list</span>(<span class="dt">folder =</span> <span class="ot">NULL</span>, <span class="dt">req_files =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="dt">public =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(folder) {</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">      <span class="kw">dir.create</span>(folder, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">      private<span class="op">$</span>folder &lt;-<span class="st"> </span>folder</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">      super<span class="op">$</span><span class="kw">initialize</span>(<span class="st">&quot;file&quot;</span>, identity)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">    },</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="dt">calculate =</span> <span class="cf">function</span>(seg_sites, trees, files, model, sim_task) {</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">      <span class="kw">file.copy</span>(files, private<span class="op">$</span>folder, <span class="dt">overwrite =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">      <span class="kw">file.path</span>(private<span class="op">$</span>folder, <span class="kw">basename</span>(files))</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    }</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  )</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">)</a></code></pre></div>
<p>This function requires only the <code>folder</code> argument on initialization, which is the folder into which the files are copied. In the <code>initialize</code> function, the folder is created and its name is stored in a private variable. Finally, it calls the constructor of <code>sumstat_class</code> via <code>super$initialize</code>. This is essential when defining your own constructors! See the <code>?sumstat_class</code> for further details.</p>
</div>
</div>
<div id="simulators" class="section level2">
<h2>Simulators</h2>
<p>Adding support for new coalescent simulators is more difficult than adding summary statistics. If you are planning to do so, I highly recommend to open an <a href="https://github.com/statgenlmu/coala/issues/new">issue</a> in coala’s bug tracker first, so that I can assist with the implementation.</p>
<p>The most important part is to create a <code>simulate</code> function that the model and the model parameters as arguments, conducts the simulation and parses the output to create the <code>segsites</code> and/or <code>trees</code> argument for the summary statistics. It should throw an error with <code>stop()</code> if it is given a model which is not supported.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
