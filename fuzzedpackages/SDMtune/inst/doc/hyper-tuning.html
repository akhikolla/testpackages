<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Sergio Vignali, Arnaud Barras &amp; Veronika Braunisch" />


<title>SDMtune - hyperparameter tuning</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      code.sourceCode > span { display: inline-block; line-height: 1.25; }
  code.sourceCode > span { color: inherit; text-decoration: inherit; }
  code.sourceCode > span:empty { height: 1.2em; }
  .sourceCode { overflow: visible; }
  code.sourceCode { white-space: pre; position: relative; }
  div.sourceCode { margin: 1em 0; }
  pre.sourceCode { margin: 0; }
  @media screen {
  div.sourceCode { overflow: auto; }
  }
  @media print {
  code.sourceCode { white-space: pre-wrap; }
  code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
  }
  pre.numberSource code
    { counter-reset: source-line 0; }
  pre.numberSource code > span
    { position: relative; left: -4em; counter-increment: source-line; }
  pre.numberSource code > span > a:first-child::before
    { content: counter(source-line);
      position: relative; left: -1em; text-align: right; vertical-align: baseline;
      border: none; display: inline-block;
      -webkit-touch-callout: none; -webkit-user-select: none;
      -khtml-user-select: none; -moz-user-select: none;
      -ms-user-select: none; user-select: none;
      padding: 0 4px; width: 4em;
      color: #aaaaaa;
    }
  pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
  div.sourceCode
    {   }
  @media screen {
  code.sourceCode > span > a:first-child::before { text-decoration: underline; }
  }
  code span.al { color: #ff0000; font-weight: bold; } /* Alert */
  code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
  code span.at { color: #7d9029; } /* Attribute */
  code span.bn { color: #40a070; } /* BaseN */
  code span.bu { } /* BuiltIn */
  code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
  code span.ch { color: #4070a0; } /* Char */
  code span.cn { color: #880000; } /* Constant */
  code span.co { color: #60a0b0; font-style: italic; } /* Comment */
  code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
  code span.do { color: #ba2121; font-style: italic; } /* Documentation */
  code span.dt { color: #902000; } /* DataType */
  code span.dv { color: #40a070; } /* DecVal */
  code span.er { color: #ff0000; font-weight: bold; } /* Error */
  code span.ex { } /* Extension */
  code span.fl { color: #40a070; } /* Float */
  code span.fu { color: #06287e; } /* Function */
  code span.im { } /* Import */
  code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  code span.kw { color: #007020; font-weight: bold; } /* Keyword */
  code span.op { color: #666666; } /* Operator */
  code span.ot { color: #007020; } /* Other */
  code span.pp { color: #bc7a00; } /* Preprocessor */
  code span.sc { color: #4070a0; } /* SpecialChar */
  code span.ss { color: #bb6688; } /* SpecialString */
  code span.st { color: #4070a0; } /* String */
  code span.va { color: #19177c; } /* Variable */
  code span.vs { color: #4070a0; } /* VerbatimString */
  code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">SDMtune - hyperparameter tuning</h1>
<h4 class="author">Sergio Vignali, Arnaud Barras &amp; Veronika Braunisch</h4>


<div id="TOC">
<ul>
<li><a href="#training-validation-and-testing-split">Training, validation and testing split</a><ul>
<li><a href="#check-the-effect-of-varying-one-hyperparameter">Check the effect of varying one hyperparameter</a></li>
</ul></li>
<li><a href="#tune-hyperparameters">Tune hyperparameters</a><ul>
<li><a href="#random-search">Random search</a></li>
<li><a href="#optimize-model">Optimize Model</a></li>
<li><a href="#evaluate-final-model">Evaluate final model</a></li>
</ul></li>
<li><a href="#hyperparameters-tuning-with-cross-validation">Hyperparameters tuning with cross validation</a></li>
</ul>
</div>

<div id="training-validation-and-testing-split" class="section level1">
<h1>Training, validation and testing split</h1>
<p>When you tune the model hyperparameters you iteratively adjust the hyperparameters while monitoring the changes in the evaluation metric computed using the testing dataset. In this process, the information contained in the testing dataset leaks in the model and therefore, at the end of the process, the testing dataset doesn’t represent anymore an independent set to evaluate the model <span class="citation">(Müller and Guido 2016, @Chollet2018)</span>. A better strategy, than splitting the observation locations in training and testing, would be to split them into training, validation and testing datasets. The training dataset is then used to train the model, the validation datasets to drive the hyperparameter tuning and the testing dataset to evaluate the tuned model. The function <code>trainValTest</code> allows to split the data in three folds containing the provided percentage of data. For illustration purpose let’s split the presence locations in training (60%), validation (20%) and testing (20%) datasets. The following steps are described in the <strong>basic-use</strong> vignette, refer to it if the following code is not clear:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(SDMtune)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(zeallot)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># Prepare data</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="kw">file.path</span>(<span class="kw">system.file</span>(<span class="dt">package =</span> <span class="st">&quot;dismo&quot;</span>), <span class="st">&quot;ex&quot;</span>),</span>
<span id="cb1-6"><a href="#cb1-6"></a>                    <span class="dt">pattern =</span> <span class="st">&quot;grd&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a>predictors &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">stack</span>(files)</span>
<span id="cb1-8"><a href="#cb1-8"></a>data &lt;-<span class="st"> </span><span class="kw">prepareSWD</span>(<span class="dt">species =</span> <span class="st">&quot;Virtual species&quot;</span>, <span class="dt">p =</span> virtualSp<span class="op">$</span>presence,</span>
<span id="cb1-9"><a href="#cb1-9"></a>                   <span class="dt">a =</span> virtualSp<span class="op">$</span>background, <span class="dt">env =</span> predictors,</span>
<span id="cb1-10"><a href="#cb1-10"></a>                   <span class="dt">categorical =</span> <span class="st">&quot;biome&quot;</span>)</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co"># Split data in training, validation and testing datasets</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw">c</span>(train, val, test) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">trainValTest</span>(data, <span class="dt">val =</span> <span class="fl">0.2</span>, <span class="dt">test =</span> <span class="fl">0.2</span>,</span>
<span id="cb1-14"><a href="#cb1-14"></a>                                      <span class="dt">only_presence =</span> <span class="ot">TRUE</span>, <span class="dt">seed =</span> <span class="dv">61516</span>)</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">cat</span>(<span class="st">&quot;# Training  : &quot;</span>, <span class="kw">nrow</span>(train<span class="op">@</span>data))</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st"># Validation: &quot;</span>, <span class="kw">nrow</span>(val<span class="op">@</span>data))</span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st"># Testing   : &quot;</span>, <span class="kw">nrow</span>(test<span class="op">@</span>data))</span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co"># Train Maxnet model with default settings</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>model &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="st">&quot;Maxnet&quot;</span>, <span class="dt">data =</span> train)</span></code></pre></div>
<div id="check-the-effect-of-varying-one-hyperparameter" class="section level2">
<h2>Check the effect of varying one hyperparameter</h2>
<p>To see the effect of varying one hyperparameter on the model performance we can use the function <code>gridSearch</code>. The function iterates through a set of predefined hyperparameter values, train the model and displays in real-time the evaluation metric in the RStudio viewer pane (hover over the points to get a tooltip with extra information). Let’s see how the AUC changes varying the regularization multiplier. First we have to define the values for the hyperparameter that we want to test. For that we create a named list that we will use as an argument for the function <code>gridSearch</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Define the values for bg</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>h &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reg =</span> <span class="kw">seq</span>(<span class="fl">0.2</span>, <span class="dv">1</span>, <span class="fl">0.1</span>))</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># Call the gridSearch function</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>exp_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">gridSearch</span>(model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">test =</span> val)</span></code></pre></div>
<p>As you noticed we used the validation dataset as test argument. The output of the function is an object of class <code>SDMtune</code>. Let’s print it:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>exp_<span class="dv">1</span></span></code></pre></div>
<p>When you print the output, the text contains the models configuration that have been used during the execution of the function. In our case, only the regularization multiplier <code>reg</code> has multiple values. You can plot the <code>SDMtune</code> object:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">plot</span>(exp_<span class="dv">1</span>, <span class="dt">title =</span> <span class="st">&quot;Experiment 1&quot;</span>)</span></code></pre></div>
<p>and you can also recreate the interactive chart using:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">plot</span>(exp_<span class="dv">1</span>, <span class="dt">title =</span> <span class="st">&quot;Experiment 1&quot;</span>, <span class="dt">interactive =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>The <code>SDMtune</code> object stores the results in the slot <code>@results</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>exp_<span class="dv">1</span><span class="op">@</span>results</span></code></pre></div>
<p>You can order them with:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>exp_<span class="dv">1</span><span class="op">@</span>results[<span class="kw">order</span>(<span class="op">-</span>exp_<span class="dv">1</span><span class="op">@</span>results<span class="op">$</span>test_AUC), ]</span></code></pre></div>
<p>In the next example we check how the TSS changes varying the regularization multiplier from 1 to 4:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r exercise"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Define the values for reg</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>h &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reg =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co"># Call the gridSearch function</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>exp_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">gridSearch</span>(model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;tss&quot;</span>, <span class="dt">test =</span> val)</span></code></pre></div>
<p>and how AUC changes varying the feature combinations using the following values: l, lq, lh, lqp, lqph and lqpht:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r exercise"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># Define the values for fc</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>h &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">fc =</span> <span class="kw">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;lq&quot;</span>, <span class="st">&quot;lh&quot;</span>, <span class="st">&quot;lqp&quot;</span>, <span class="st">&quot;lqph&quot;</span>, <span class="st">&quot;lqpht&quot;</span>))</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># Call the gridSearch function</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>exp_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">gridSearch</span>(model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">test =</span> val)</span></code></pre></div>
<p>Train a <strong>Maxent</strong> model and see how the AUC changes varying the number of iterations from 300 to 1100 with increments of 200 (highlight to see the solution):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r exercise"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>maxent_model &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="st">&quot;Maxent&quot;</span>, <span class="dt">data =</span> data)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co"># Define the values for fc</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>h &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&quot;iter&quot;</span> =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">300</span>, <span class="dv">1100</span>, <span class="dv">200</span>))</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co"># Call the gridSearch function</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>exp_<span class="dv">4</span> &lt;-<span class="st"> </span><span class="kw">gridSearch</span>(maxent_model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">test =</span> val)</span></code></pre></div>
<p>To see which hyperparameters can be tuned in a given model use the function <code>getTunableArgs</code>. For example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">getTunableArgs</span>(model)</span></code></pre></div>
</div>
</div>
<div id="tune-hyperparameters" class="section level1">
<h1>Tune hyperparameters</h1>
<p>To tune the model hyperparameters you should run all the possible combinations of hyperparameters. Here is an example using combinations of regularization multiplier and feature classes:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>h &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reg =</span> <span class="kw">seq</span>(<span class="fl">0.2</span>, <span class="dv">2</span>, <span class="fl">0.2</span>),</span>
<span id="cb12-2"><a href="#cb12-2"></a>          <span class="dt">fc =</span> <span class="kw">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;lq&quot;</span>, <span class="st">&quot;lh&quot;</span>, <span class="st">&quot;lqp&quot;</span>, <span class="st">&quot;lqph&quot;</span>, <span class="st">&quot;lqpht&quot;</span>))</span>
<span id="cb12-3"><a href="#cb12-3"></a>exp_<span class="dv">5</span> &lt;-<span class="st"> </span><span class="kw">gridSearch</span>(model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">test =</span> val)</span></code></pre></div>
<p>This code takes already quite long as it has to train 60 models. Imagine if you want to check more values for the regularization multiplier and maybe add the number of iterations (in the case of a <strong>Maxent</strong> model). The number of models to be trained increases exponentially and consequently the execution time. In the next two paragraphs we will present two possible alternative to the <code>gridSearch</code> function.</p>
<div id="random-search" class="section level2">
<h2>Random search</h2>
<p>The function <code>randomSearch</code> trains models taking a random sample of the predefined configurations. In the next example we select 10 random configurations:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>h &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reg =</span> <span class="kw">seq</span>(<span class="fl">0.2</span>, <span class="dv">5</span>, <span class="fl">0.2</span>), <span class="dt">fc =</span> <span class="kw">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;lq&quot;</span>, <span class="st">&quot;lh&quot;</span>, <span class="st">&quot;lp&quot;</span>, <span class="st">&quot;lqp&quot;</span>, <span class="st">&quot;lqph&quot;</span>))</span>
<span id="cb13-2"><a href="#cb13-2"></a>exp_<span class="dv">6</span> &lt;-<span class="st"> </span><span class="kw">randomSearch</span>(model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">test =</span> val, <span class="dt">pop =</span> <span class="dv">10</span>,</span>
<span id="cb13-3"><a href="#cb13-3"></a>                      <span class="dt">seed =</span> <span class="dv">65466</span>)</span></code></pre></div>
<p>The real-time chart plots two different graphs, one with the chosen metric for each trained model and one with the evaluation metric for the starting and the best found model. As you can see, the function is able to find a better combination of the model hyperparameters compared to the starting model; and this training only 10 instead of 150 models. The results includes the 10 trained model. If you are not happy with the solution, you can check the best hyperparameter combinations and this gives you an intuition of which ones are the hyperparameters to “refine” using the function <code>gridSearch</code>. The <code>SDMtune</code> object stores the results in a <code>data.frame</code> than can be accessed with the following command:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>exp_<span class="dv">6</span><span class="op">@</span>results</span></code></pre></div>
</div>
<div id="optimize-model" class="section level2">
<h2>Optimize Model</h2>
<p>The previous function doesn’t learn anything from the trained models, it just selects n random combinations of hyperparameters. The function <code>optimizeModel</code> instead uses a <em>genetic algorithm</em> to find an optimum or near optimum solution. Check the function documentation to understand how it works, here we provide the code to execute it:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>exp_<span class="dv">7</span> &lt;-<span class="st"> </span><span class="kw">optimizeModel</span>(model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">test =</span> val, <span class="dt">pop =</span> <span class="dv">15</span>,</span>
<span id="cb15-2"><a href="#cb15-2"></a>                       <span class="dt">gen =</span> <span class="dv">2</span>, <span class="dt">seed =</span> <span class="dv">798</span>)</span></code></pre></div>
</div>
<div id="evaluate-final-model" class="section level2">
<h2>Evaluate final model</h2>
<p>Let’s say we want to use the best tuned model found by the <code>randomSearch</code> function. Before evaluating the model using the testing dataset, we can merge the training and the validation datasets together to increase the number of locations and train a new model with the merged observations and the tuned configuration. At this point we may have removed variables using the <code>varSel</code> or <code>reduceVar</code> function. If this is the case, we cannot merge directly the initial datasets which contain all the environmental variables. We can extract the train dataset with the selected variables from the output of the experiment and merge it with the validation dataset using the function <code>mergeSWD</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>index &lt;-<span class="st"> </span><span class="kw">which.max</span>(exp_<span class="dv">6</span><span class="op">@</span>results<span class="op">$</span>test_AUC)  <span class="co"># Index of the best model in the experiment</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>new_train &lt;-<span class="st"> </span>exp_<span class="dv">6</span><span class="op">@</span>models[[index]]<span class="op">@</span>data  <span class="co"># New train dataset containing only the selected variables</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>merged_data &lt;-<span class="st"> </span><span class="kw">mergeSWD</span>(new_train, val, <span class="dt">only_presence =</span> <span class="ot">TRUE</span>) <span class="co"># Merge only presence data</span></span></code></pre></div>
<p>The <code>val</code> dataset contains all the initial environmental variables but the <code>mergeSWD</code> function will merge only those that are present in both datasets (in case you have performed variable selection).</p>
<p>Then we get the model configuration from the experiment 6:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>final_model &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="st">&quot;Maxnet&quot;</span>, <span class="dt">data =</span> merged_data, <span class="dt">fc =</span> exp_<span class="dv">6</span><span class="op">@</span>results[index, <span class="dv">1</span>],</span>
<span id="cb17-2"><a href="#cb17-2"></a>                     <span class="dt">reg =</span> exp_<span class="dv">6</span><span class="op">@</span>results[index, <span class="dv">2</span>])</span></code></pre></div>
<p>Now we can evaluate the final model using the held apart testing dataset:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">auc</span>(final_model, <span class="dt">test =</span> test)</span></code></pre></div>
</div>
</div>
<div id="hyperparameters-tuning-with-cross-validation" class="section level1">
<h1>Hyperparameters tuning with cross validation</h1>
<p>Another approach would be to split the data in two folds: training and testing, use the cross validation strategy with the training dataset to tune the model hyperparameters, and evaluate the tuned model with the unseen held apart testing dataset.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Create the folds from the training dataset</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>folds &lt;-<span class="st"> </span><span class="kw">randomFolds</span>(train, <span class="dt">k =</span> <span class="dv">4</span>, <span class="dt">only_presence =</span> <span class="ot">TRUE</span>, <span class="dt">seed =</span> <span class="dv">25</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="co"># Train the model</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>cv_model &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="st">&quot;Maxent&quot;</span>, <span class="dt">data =</span> train, <span class="dt">folds =</span> folds)</span></code></pre></div>
<p>All the previous examples can be applied to the cross validation, here an example with <code>randomSearch</code> (note that in this case the testing dataset is not provided as is taken from the folds stored in the <code>SDMmodelCV</code>):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>h &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">reg =</span> <span class="kw">seq</span>(<span class="fl">0.2</span>, <span class="dv">5</span>, <span class="fl">0.2</span>), <span class="dt">fc =</span> <span class="kw">c</span>(<span class="st">&quot;l&quot;</span>, <span class="st">&quot;lq&quot;</span>, <span class="st">&quot;lh&quot;</span>, <span class="st">&quot;lp&quot;</span>, <span class="st">&quot;lqp&quot;</span>, <span class="st">&quot;lqph&quot;</span>))</span>
<span id="cb20-2"><a href="#cb20-2"></a>exp_<span class="dv">8</span> &lt;-<span class="st"> </span><span class="kw">randomSearch</span>(cv_model, <span class="dt">hypers =</span> h, <span class="dt">metric =</span> <span class="st">&quot;auc&quot;</span>, <span class="dt">pop =</span> <span class="dv">10</span>,</span>
<span id="cb20-3"><a href="#cb20-3"></a>                      <span class="dt">seed =</span> <span class="dv">65466</span>)</span></code></pre></div>
<p>The function <code>randomSearch</code> orders the models according to the best value of the metric for the testing dataset. In this case we can train a model using the best hyperparameters configuration and without cross validation with:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>final_model &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="st">&quot;Maxent&quot;</span>, <span class="dt">data =</span> exp_<span class="dv">8</span><span class="op">@</span>models[[<span class="dv">1</span>]]<span class="op">@</span>data,</span>
<span id="cb21-2"><a href="#cb21-2"></a>                     <span class="dt">fc =</span> exp_<span class="dv">8</span><span class="op">@</span>results[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dt">reg =</span> exp_<span class="dv">8</span><span class="op">@</span>results[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="kw">auc</span>(final_model, <span class="dt">test =</span> test)</span></code></pre></div>
<div id="refs" class="references">
<div id="ref-Chollet2018">
<p>Chollet, François, and J. J. Allaire. 2018. <em>Deep learning with R</em>. 1st ed. Manning Publications Co.</p>
</div>
<div id="ref-Muller2016">
<p>Müller, Andreas C., and Sarah Guido. 2016. <em>Introduction to machine learning with Python : a guide for data scientists</em>.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
