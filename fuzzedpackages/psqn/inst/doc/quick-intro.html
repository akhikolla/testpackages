<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>A Quick Introduction to the psqn Package</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">A Quick Introduction to the psqn Package</h1>



<p><span class="math display">\[\renewcommand\vec{\boldsymbol}   \def\bigO#1{\mathcal{O}(#1)}   \def\Cond#1#2{\left(#1\,\middle|\, #2\right)}   \def\mat#1{\boldsymbol{#1}}   \def\der{{\mathop{}\!\mathrm{d}}}   \def\argmax{\text{arg}\,\text{max}}  \def\Prob{\text{P}}  \def\diag{\text{diag}}   \def\argmin{\text{arg}\,\text{min}}   \def\Expe{\text{E}}\]</span></p>
<p>This is a quick introduction to the psqn package. A more detailed description can be found in the psqn vignette (call <code>vignette(&quot;psqn&quot;, package = &quot;psqn&quot;)</code>). The main function in the package is the <code>psqn</code> function. The <code>psqn</code> function minimizes functions which can be written like:</p>
<p><span class="math display">\[f(\vec x) = \sum_{i = 1}^n f_i(\vec x_{\mathcal I_i})\]</span></p>
<p>where <span class="math inline">\(\vec x\in \mathbb R^l\)</span>,</p>
<p><span class="math display">\[\vec x_{\mathcal I_i} = (\vec e_{j_{i1}}^\top, \dots ,\vec e_{j_{im_i}}^\top)\vec x, \qquad    \mathcal I_i = (j_{i1}, \dots, \mathcal j_{im_i}) \subseteq    \{1, \dots, l\}^l,\]</span></p>
<p>and <span class="math inline">\(\vec e_k\)</span> is the <span class="math inline">\(k\)</span>’th column of the <span class="math inline">\(l\)</span> dimensional identity matrix. We call the <span class="math inline">\(f_i\)</span>s element functions and assume that each of them only depend on a small number of variables. Furthermore, we assume that each index set <span class="math inline">\(\mathcal I_i\)</span> is of the form:</p>
<p><span class="math display">\[\begin{align*}   \mathcal I_i &amp;= \{1,\dots, p\} \cup \mathcal J_i \\   \mathcal J_i \cap \mathcal J_j &amp;= \emptyset \qquad j\neq i \\   \mathcal J_i \cap \{1,\dots, p\} &amp;= \emptyset \qquad \forall i = 1,\dots, n   \end{align*}.\]</span></p>
<p>That is, each index set contains <span class="math inline">\(p\)</span> <em>global parameters</em> and <span class="math inline">\(q_i = \lvert\mathcal J_i\rvert\)</span> <em>private parameters</em> which are particular for each element function, <span class="math inline">\(f_i\)</span>. For implementation reason, we let:</p>
<p><span class="math display">\[\begin{align*}   \overleftarrow q_i &amp;=    \begin{cases} p &amp; i = 0 \\ p + \sum_{k = 1}^i q_k &amp; i &gt; 0 \end{cases} \\   \mathcal J_i &amp;=    \{1 + \overleftarrow q_{i - 1}, \dots , q_i + \overleftarrow q_{i - 1}\}   \end{align*}\]</span></p>
<p>such that the element functions’ private parameters lies in consecutive parts of <span class="math inline">\(\vec x\)</span>.</p>
<div id="the-r-interface" class="section level2">
<h2>The R Interface</h2>
<p>As a simple example, we consider the element functions:</p>
<p><span class="math display">\[
f_i((\vec\beta^\top, \vec u^\top_i)^\top) = -\vec y_i(\mat X_i\vec\beta + \mat Z_i\vec u_i)     + \sum_{k = 1}^{t_i}   \log(1 + \exp(\vec x_{ik}^\top\vec\beta + \vec z_{ik}^\top\vec u_i))   + \frac 12 \vec u^\top_i\mat\Sigma^{-1} \vec u_i.
\]</span></p>
<p><span class="math inline">\(\vec\beta\)</span> is the <span class="math inline">\(p\)</span> dimensional global parameter and <span class="math inline">\(\vec u_i\)</span> is the <span class="math inline">\(q_i = q\)</span> dimensional private parameters for the <span class="math inline">\(i\)</span>th element function. <span class="math inline">\(\vec y_i\in \{0, 1\}^{t_i}\)</span>, <span class="math inline">\(\mat X_i\in\mathbb R^{t_i\times p}\)</span>, and <span class="math inline">\(\mat Z_i\in\mathbb R^{t_i\times q}\)</span> are particular to each element function. We simulate some data below to use:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># assign global parameters, number of private parameters, etc.</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">q &lt;-<span class="st"> </span><span class="dv">4</span> <span class="co"># number of private parameters per cluster</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="dv">5</span> <span class="co"># number of global parameters</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">beta &lt;-<span class="st"> </span><span class="kw">sqrt</span>((<span class="dv">1</span><span class="op">:</span>p) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(<span class="dv">1</span><span class="op">:</span>p))</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">Sigma &lt;-<span class="st"> </span><span class="kw">diag</span>(q)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co"># simulate a data set</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">n_ele_func &lt;-<span class="st"> </span>1000L <span class="co"># number of element functions</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw">set.seed</span>(<span class="dv">80919915</span>)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">sim_dat &lt;-<span class="st"> </span><span class="kw">replicate</span>(n_ele_func, {</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  t_i &lt;-<span class="st"> </span><span class="kw">sample.int</span>(40L, 1L) <span class="op">+</span><span class="st"> </span>2L</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">  X &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(p <span class="op">*</span><span class="st"> </span>t_i, <span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">6</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>), <span class="kw">sqrt</span>(<span class="dv">6</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)), </a>
<a class="sourceLine" id="cb1-14" data-line-number="14">              p)</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">  u &lt;-<span class="st"> </span><span class="kw">drop</span>(<span class="kw">rnorm</span>(q) <span class="op">%*%</span><span class="st"> </span><span class="kw">chol</span>(Sigma))</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">  Z &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(q <span class="op">*</span><span class="st"> </span>t_i, <span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">6</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>q), <span class="kw">sqrt</span>(<span class="dv">6</span> <span class="op">/</span><span class="st"> </span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>q)), </a>
<a class="sourceLine" id="cb1-17" data-line-number="17">              q)</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">  eta &lt;-<span class="st"> </span><span class="kw">drop</span>(beta <span class="op">%*%</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>u <span class="op">%*%</span><span class="st"> </span>Z)</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">  y &lt;-<span class="st"> </span><span class="kw">as.numeric</span>((<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>eta))<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>) <span class="op">&gt;</span><span class="st"> </span><span class="kw">runif</span>(t_i))</a>
<a class="sourceLine" id="cb1-20" data-line-number="20">  </a>
<a class="sourceLine" id="cb1-21" data-line-number="21">  <span class="kw">list</span>(<span class="dt">X =</span> X, <span class="dt">Z =</span> Z, <span class="dt">y =</span> y, <span class="dt">u =</span> u, <span class="dt">Sigma_inv =</span> <span class="kw">solve</span>(Sigma))</a>
<a class="sourceLine" id="cb1-22" data-line-number="22">}, <span class="dt">simplify =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb1-23" data-line-number="23"></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"><span class="co"># data for the first element function</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25">sim_dat[[1L]]</a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="co">#&gt; $X</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="co">#&gt;        [,1]   [,2]   [,3]   [,4]   [,5]    [,6]   [,7]   [,8]   [,9]  [,10]</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="co">#&gt; [1,]  0.147 -1.246  0.840 -1.083  0.701 -1.6532  0.549  1.522 -0.449  0.254</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co">#&gt; [2,] -0.241  1.391 -0.873 -0.877  1.005  1.5401 -0.207 -0.999  1.249  1.379</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="co">#&gt; [3,] -1.713  0.698  1.550 -1.335  0.687  0.0999  0.688  0.493 -0.992  0.780</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="co">#&gt; [4,]  1.116  1.687  0.557 -1.380  0.294  1.2391 -1.331 -0.459  0.262 -1.351</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="co">#&gt; [5,] -0.391  1.310 -1.477 -0.836 -1.542  1.3278 -0.788 -0.675 -1.184  0.208</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="co">#&gt;        [,11]  [,12]   [,13]  [,14]  [,15]  [,16]   [,17]  [,18]    [,19]  [,20]</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="co">#&gt; [1,]  0.3633 -0.578  1.5378  1.488  0.653  1.707 -1.4558 -1.396  0.58917  1.473</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="co">#&gt; [2,] -0.4122 -0.616 -1.2711  0.256 -1.494  0.615 -0.4410  0.114 -0.56704 -0.261</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="co">#&gt; [3,]  0.0818 -0.272 -1.4706  1.060 -0.959 -1.141  0.0916 -0.928  1.68352 -0.155</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="co">#&gt; [4,] -1.4245  1.716 -0.9433  0.428  1.670 -0.254 -0.1064 -0.245  0.00692  0.161</span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="co">#&gt; [5,]  1.6009  1.628  0.0971 -0.818  0.402 -0.497 -1.3034  0.636  0.72653 -0.425</span></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"><span class="co">#&gt;       [,21]   [,22]   [,23]  [,24]  [,25]   [,26]  [,27]    [,28]  [,29]  [,30]</span></a>
<a class="sourceLine" id="cb1-40" data-line-number="40"><span class="co">#&gt; [1,] -1.086 -0.8711  1.2213  0.698  0.721  0.9319 -0.326 -0.00238 -1.164  0.203</span></a>
<a class="sourceLine" id="cb1-41" data-line-number="41"><span class="co">#&gt; [2,]  0.397  1.1903 -0.3113 -0.837  1.501 -0.0304  1.509 -0.17466  0.547 -0.667</span></a>
<a class="sourceLine" id="cb1-42" data-line-number="42"><span class="co">#&gt; [3,]  0.440  0.0235 -0.7929  0.305 -0.809  0.0949 -0.946 -0.44998 -0.761 -0.724</span></a>
<a class="sourceLine" id="cb1-43" data-line-number="43"><span class="co">#&gt; [4,]  0.222  1.2529 -0.0905 -0.879 -0.274  1.0152  0.492 -1.48076 -0.213  1.332</span></a>
<a class="sourceLine" id="cb1-44" data-line-number="44"><span class="co">#&gt; [5,]  0.872 -1.2783  1.0110 -1.225  0.904  1.0819 -1.243  0.34144  0.919  0.404</span></a>
<a class="sourceLine" id="cb1-45" data-line-number="45"><span class="co">#&gt;       [,31]  [,32]   [,33]  [,34]  [,35]  [,36]  [,37]  [,38]</span></a>
<a class="sourceLine" id="cb1-46" data-line-number="46"><span class="co">#&gt; [1,] -0.333 -0.842 -0.3760  1.529  0.439 -1.227 -0.235 -0.562</span></a>
<a class="sourceLine" id="cb1-47" data-line-number="47"><span class="co">#&gt; [2,]  0.649  1.103 -1.1518 -0.277 -1.369 -0.951  1.702  1.685</span></a>
<a class="sourceLine" id="cb1-48" data-line-number="48"><span class="co">#&gt; [3,]  1.370 -1.343  1.5827  0.355  0.457 -1.509 -1.427  0.779</span></a>
<a class="sourceLine" id="cb1-49" data-line-number="49"><span class="co">#&gt; [4,]  0.179  1.544 -0.0281 -0.199 -0.923 -0.524  0.406  0.515</span></a>
<a class="sourceLine" id="cb1-50" data-line-number="50"><span class="co">#&gt; [5,]  0.138 -0.470  1.4224  0.271 -0.424  1.090  0.290  1.585</span></a>
<a class="sourceLine" id="cb1-51" data-line-number="51"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-52" data-line-number="52"><span class="co">#&gt; $Z</span></a>
<a class="sourceLine" id="cb1-53" data-line-number="53"><span class="co">#&gt;        [,1]   [,2]    [,3]   [,4]    [,5]   [,6]    [,7]     [,8]    [,9]</span></a>
<a class="sourceLine" id="cb1-54" data-line-number="54"><span class="co">#&gt; [1,] -0.178  0.838 -0.6811 -0.752 -0.0552 -0.076 -0.0308 -0.19838  0.7404</span></a>
<a class="sourceLine" id="cb1-55" data-line-number="55"><span class="co">#&gt; [2,]  0.843  0.372 -0.0235 -0.652 -0.1140 -0.531  0.7292  0.74028  0.0757</span></a>
<a class="sourceLine" id="cb1-56" data-line-number="56"><span class="co">#&gt; [3,]  0.432  0.231  0.8555  0.624  0.2864  0.583  0.5691  0.00112 -0.6749</span></a>
<a class="sourceLine" id="cb1-57" data-line-number="57"><span class="co">#&gt; [4,] -0.288 -0.297  0.6028  0.536 -0.8658  0.142 -0.0209  0.53635  0.8298</span></a>
<a class="sourceLine" id="cb1-58" data-line-number="58"><span class="co">#&gt;       [,10]  [,11]  [,12]  [,13]   [,14]   [,15]  [,16]   [,17]  [,18]  [,19]</span></a>
<a class="sourceLine" id="cb1-59" data-line-number="59"><span class="co">#&gt; [1,] 0.0646 -0.657 -0.566  0.806 -0.1562  0.0875 -0.039 -0.7200  0.835  0.220</span></a>
<a class="sourceLine" id="cb1-60" data-line-number="60"><span class="co">#&gt; [2,] 0.6481 -0.232  0.215 -0.425  0.0812 -0.3133  0.378 -0.0546 -0.553 -0.365</span></a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="co">#&gt; [3,] 0.1781 -0.331  0.691  0.683 -0.8539 -0.8270 -0.257 -0.4874 -0.753  0.747</span></a>
<a class="sourceLine" id="cb1-62" data-line-number="62"><span class="co">#&gt; [4,] 0.7046  0.643  0.141 -0.308 -0.7163  0.7274 -0.711 -0.0990 -0.400  0.642</span></a>
<a class="sourceLine" id="cb1-63" data-line-number="63"><span class="co">#&gt;       [,20]  [,21]   [,22]   [,23]   [,24]  [,25]  [,26]  [,27]  [,28]   [,29]</span></a>
<a class="sourceLine" id="cb1-64" data-line-number="64"><span class="co">#&gt; [1,] -0.315 -0.395 -0.4401 -0.1950  0.0695 -0.402 -0.297 -0.862 -0.448  0.8003</span></a>
<a class="sourceLine" id="cb1-65" data-line-number="65"><span class="co">#&gt; [2,] -0.053 -0.498 -0.6587  0.0463  0.4262 -0.440 -0.551  0.852  0.764  0.6065</span></a>
<a class="sourceLine" id="cb1-66" data-line-number="66"><span class="co">#&gt; [3,] -0.323  0.307  0.3877  0.5228 -0.5408 -0.532 -0.758  0.346 -0.847 -0.6973</span></a>
<a class="sourceLine" id="cb1-67" data-line-number="67"><span class="co">#&gt; [4,] -0.779 -0.779  0.0879  0.8470 -0.1618 -0.320 -0.858  0.527 -0.784  0.0282</span></a>
<a class="sourceLine" id="cb1-68" data-line-number="68"><span class="co">#&gt;        [,30]    [,31]  [,32]  [,33]  [,34]   [,35]  [,36]  [,37]  [,38]</span></a>
<a class="sourceLine" id="cb1-69" data-line-number="69"><span class="co">#&gt; [1,] -0.4176 -0.60760  0.502 -0.816 -0.568 -0.3325 -0.085 -0.656 -0.828</span></a>
<a class="sourceLine" id="cb1-70" data-line-number="70"><span class="co">#&gt; [2,] -0.6609  0.00662  0.296  0.480 -0.538 -0.3001  0.750  0.375 -0.358</span></a>
<a class="sourceLine" id="cb1-71" data-line-number="71"><span class="co">#&gt; [3,]  0.1750  0.25447  0.124 -0.367  0.129 -0.0108  0.711  0.751 -0.159</span></a>
<a class="sourceLine" id="cb1-72" data-line-number="72"><span class="co">#&gt; [4,]  0.0145  0.08370 -0.802  0.500  0.263 -0.0894 -0.637  0.416 -0.677</span></a>
<a class="sourceLine" id="cb1-73" data-line-number="73"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-74" data-line-number="74"><span class="co">#&gt; $y</span></a>
<a class="sourceLine" id="cb1-75" data-line-number="75"><span class="co">#&gt;  [1] 1 1 0 0 1 0 0 0 0 1 0 1 1 1 1 1 0 0 1 1 1 1 1 1 1 1 0 0 0 1 1 1 0 0 0 1 1 1</span></a>
<a class="sourceLine" id="cb1-76" data-line-number="76"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-77" data-line-number="77"><span class="co">#&gt; $u</span></a>
<a class="sourceLine" id="cb1-78" data-line-number="78"><span class="co">#&gt; [1] -0.170  0.427  0.918 -2.080</span></a>
<a class="sourceLine" id="cb1-79" data-line-number="79"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb1-80" data-line-number="80"><span class="co">#&gt; $Sigma_inv</span></a>
<a class="sourceLine" id="cb1-81" data-line-number="81"><span class="co">#&gt;      [,1] [,2] [,3] [,4]</span></a>
<a class="sourceLine" id="cb1-82" data-line-number="82"><span class="co">#&gt; [1,]    1    0    0    0</span></a>
<a class="sourceLine" id="cb1-83" data-line-number="83"><span class="co">#&gt; [2,]    0    1    0    0</span></a>
<a class="sourceLine" id="cb1-84" data-line-number="84"><span class="co">#&gt; [3,]    0    0    1    0</span></a>
<a class="sourceLine" id="cb1-85" data-line-number="85"><span class="co">#&gt; [4,]    0    0    0    1</span></a></code></pre></div>
<p>We work with <span class="math inline">\(\mat X_i^\top\)</span> and <span class="math inline">\(\mat Z_i^\top\)</span> for computational reasons. The function we need to pass to <code>psqn</code> needs to take three arguments:</p>
<ul>
<li>An index of the element function.</li>
<li>A vector with <span class="math inline">\(\vec x_{\mathcal I_i}\)</span>. It will have length zero if the backend requests an integer vector with <span class="math inline">\(p\)</span> and <span class="math inline">\(q_i\)</span>.</li>
<li>A logical variable which is <code>TRUE</code> if the function should return an attribute with the gradient with respect to <span class="math inline">\(\vec x_{\mathcal I_i}\)</span>.</li>
</ul>
<p>The function should return the element function value (potentially with the gradient as an attribute) or <span class="math inline">\(p\)</span> and <span class="math inline">\(q_i\)</span>. Thus, an example in our case will be:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">r_func &lt;-<span class="st"> </span><span class="cf">function</span>(i, par, comp_grad){</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  dat &lt;-<span class="st"> </span>sim_dat[[i]]</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  X &lt;-<span class="st"> </span>dat<span class="op">$</span>X</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  Z &lt;-<span class="st"> </span>dat<span class="op">$</span>Z</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="cf">if</span>(<span class="kw">length</span>(par) <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="co"># requested the dimension of the parameter</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">    <span class="kw">return</span>(<span class="kw">c</span>(<span class="dt">global_dim =</span> <span class="kw">NROW</span>(dat<span class="op">$</span>X), <span class="dt">private_dim =</span> <span class="kw">NROW</span>(dat<span class="op">$</span>Z)))</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  y &lt;-<span class="st"> </span>dat<span class="op">$</span>y</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  Sigma_inv &lt;-<span class="st"> </span>dat<span class="op">$</span>Sigma_inv</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  beta &lt;-<span class="st"> </span>par[<span class="dv">1</span><span class="op">:</span>p]</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  u_i &lt;-<span class="st"> </span>par[<span class="dv">1</span><span class="op">:</span>q <span class="op">+</span><span class="st"> </span>p]</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  eta &lt;-<span class="st"> </span><span class="kw">drop</span>(beta <span class="op">%*%</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>u_i <span class="op">%*%</span><span class="st"> </span>Z)</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">  exp_eta &lt;-<span class="st"> </span><span class="kw">exp</span>(eta)</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb2-18" data-line-number="18">  <span class="co"># compute the element function</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">  out &lt;-<span class="st"> </span><span class="op">-</span><span class="kw">sum</span>(y <span class="op">*</span><span class="st"> </span>eta) <span class="op">+</span><span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>exp_eta)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="st">    </span><span class="kw">sum</span>(u_i <span class="op">*</span><span class="st"> </span>(Sigma_inv <span class="op">%*%</span><span class="st"> </span>u_i)) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">  </a>
<a class="sourceLine" id="cb2-22" data-line-number="22">  <span class="cf">if</span>(comp_grad){</a>
<a class="sourceLine" id="cb2-23" data-line-number="23">    <span class="co"># we also need to compute the gradient</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">    d_eta &lt;-<span class="st"> </span><span class="op">-</span>y <span class="op">+</span><span class="st"> </span>exp_eta <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>exp_eta)</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">    grad &lt;-<span class="st"> </span><span class="kw">c</span>(X <span class="op">%*%</span><span class="st"> </span>d_eta, </a>
<a class="sourceLine" id="cb2-26" data-line-number="26">              Z <span class="op">%*%</span><span class="st"> </span>d_eta <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>Sigma_inv <span class="op">%*%</span><span class="st"> </span>u_i)</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">    <span class="kw">attr</span>(out, <span class="st">&quot;grad&quot;</span>) &lt;-<span class="st"> </span>grad</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">  }</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">  </a>
<a class="sourceLine" id="cb2-30" data-line-number="30">  out</a>
<a class="sourceLine" id="cb2-31" data-line-number="31">}</a></code></pre></div>
<p>Then we can optimize the function as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(psqn)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">start_val &lt;-<span class="st"> </span><span class="kw">numeric</span>(p <span class="op">+</span><span class="st"> </span>n_ele_func <span class="op">*</span><span class="st"> </span>q) <span class="co"># the starting value</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">opt_res &lt;-<span class="st"> </span><span class="kw">psqn</span>(<span class="dt">par =</span> start_val, <span class="dt">fn =</span> r_func, <span class="dt">n_ele_func =</span> n_ele_func)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co"># check the minimum</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">opt_res<span class="op">$</span>value</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; [1] 11969</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co"># check the estimated global parameters</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">head</span>(opt_res<span class="op">$</span>par, <span class="kw">length</span>(beta))</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; [1] 0.254 0.356 0.410 0.520 0.564</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co"># should be close to </span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">beta</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt; [1] 0.258 0.365 0.447 0.516 0.577</span></a></code></pre></div>
</div>
<div id="ending-remarks" class="section level2">
<h2>Ending Remarks</h2>
<p>The package can also be used as a header-only library in C++. This can yield a very large reduction in computation time and be easy to implement with the Rcpp package. Two examples are shown in the psqn vignette (see <code>vignette(&quot;psqn&quot;, package = &quot;psqn&quot;)</code>).</p>
<p>There is also a BFGS implementation in the package. This can be used in R with the <code>psqn_bfgs</code> function. The BFGS implementation can also be used in C++ using the psqn-bfgs.h file.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
