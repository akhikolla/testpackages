<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Tommy Jones" />

<meta name="date" content="2020-10-20" />

<title>Getting Started With mvrsquared</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      a.sourceLine { display: inline-block; line-height: 1.25; }
  a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
  a.sourceLine:empty { height: 1.2em; }
  .sourceCode { overflow: visible; }
  code.sourceCode { white-space: pre; position: relative; }
  div.sourceCode { margin: 1em 0; }
  pre.sourceCode { margin: 0; }
  @media screen {
  div.sourceCode { overflow: auto; }
  }
  @media print {
  code.sourceCode { white-space: pre-wrap; }
  a.sourceLine { text-indent: -1em; padding-left: 1em; }
  }
  pre.numberSource a.sourceLine
    { position: relative; left: -4em; }
  pre.numberSource a.sourceLine::before
    { content: attr(data-line-number);
      position: relative; left: -1em; text-align: right; vertical-align: baseline;
      border: none; pointer-events: all; display: inline-block;
      -webkit-touch-callout: none; -webkit-user-select: none;
      -khtml-user-select: none; -moz-user-select: none;
      -ms-user-select: none; user-select: none;
      padding: 0 4px; width: 4em;
      color: #aaaaaa;
    }
  pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
  div.sourceCode
    {  }
  @media screen {
  a.sourceLine::before { text-decoration: underline; }
  }
  code span.al { color: #ff0000; font-weight: bold; } /* Alert */
  code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
  code span.at { color: #7d9029; } /* Attribute */
  code span.bn { color: #40a070; } /* BaseN */
  code span.bu { } /* BuiltIn */
  code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
  code span.ch { color: #4070a0; } /* Char */
  code span.cn { color: #880000; } /* Constant */
  code span.co { color: #60a0b0; font-style: italic; } /* Comment */
  code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
  code span.do { color: #ba2121; font-style: italic; } /* Documentation */
  code span.dt { color: #902000; } /* DataType */
  code span.dv { color: #40a070; } /* DecVal */
  code span.er { color: #ff0000; font-weight: bold; } /* Error */
  code span.ex { } /* Extension */
  code span.fl { color: #40a070; } /* Float */
  code span.fu { color: #06287e; } /* Function */
  code span.im { } /* Import */
  code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  code span.kw { color: #007020; font-weight: bold; } /* Keyword */
  code span.op { color: #666666; } /* Operator */
  code span.ot { color: #007020; } /* Other */
  code span.pp { color: #bc7a00; } /* Preprocessor */
  code span.sc { color: #4070a0; } /* SpecialChar */
  code span.ss { color: #bb6688; } /* SpecialString */
  code span.st { color: #4070a0; } /* String */
  code span.va { color: #19177c; } /* Variable */
  code span.vs { color: #4070a0; } /* VerbatimString */
  code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Getting Started With mvrsquared</h1>
<h4 class="author">Tommy Jones</h4>
<h4 class="date">2020-10-20</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Welcome to the <code>mvrsquared</code> package! This package does one thing: calculate the <a href="https://en.wikipedia.org/wiki/Coefficient_of_determination">coefficient of determination</a> or R-squared. However, this implementation is different from what you may be familiar with. In addition to the standard R-squared used frequently in linear regression, <code>mvrsquared</code> calculates R-squared for multivariate outcomes. (This is why there is an ‘mv’ in <code>mvrsquared</code>).</p>
<p><code>mvrsquared</code> implements R-squared based on a derivation in <a href="https://arxiv.org/abs/1911.11061">this paper</a>. It’s the same definition of R-squared you’re probably familiar with (<span class="math inline">\(1 - \frac{SSE}{SST}\)</span>) but generalized to n-dimensions.</p>
<p>In the standard case, your outcome <span class="math inline">\(y\)</span> and prediction <span class="math inline">\(\hat{y}\)</span> are vectors. In other words, each observation is a single number. This is fine if you are predicting a single variable. But what if you are predicting multiple variables at once? In that case, <span class="math inline">\(y\)</span> and <span class="math inline">\(\hat{y}\)</span> are matrices. This situation occurs frequently in topic modeling or simultaneous equation modeling.</p>
<p>Below are some examples of using <code>mvrsquared</code> for calculating R-squared in the traditional context and for multivariate outcomes.</p>
</div>
<div id="traditional-r-squared" class="section level1">
<h1>Traditional R-squared</h1>
<p>Below is a simple example comparing the R-squared calculated from a linear model fit by <code>lm</code> in the <code>stats</code> package and the R-squared calculated in the <code>mvrsquared</code> package. (Spoiler alert: they’re identical.) Why do this? If <code>mvrsquared</code> can’t get the same calculation, you probably shouldn’t trust it. (Spoiler alert again: it can and you should.)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(mvrsquared)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">data</span>(mtcars)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co"># fit a linear model</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">f &lt;-<span class="st"> </span><span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>cyl <span class="op">+</span><span class="st"> </span>disp <span class="op">+</span><span class="st"> </span>hp <span class="op">+</span><span class="st"> </span>wt, <span class="dt">data =</span> mtcars)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co"># extract r-squared </span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">f_summary &lt;-<span class="st"> </span><span class="kw">summary</span>(f)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">r2_lm &lt;-<span class="st"> </span>f_summary<span class="op">$</span>r.squared</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">r2_lm</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co">#&gt; [1] 0.8486348</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co"># calculate univariate r-squared using mvrsquared</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">r2_mv &lt;-<span class="st"> </span><span class="kw">calc_rsquared</span>(<span class="dt">y =</span> mtcars<span class="op">$</span>mpg, <span class="dt">yhat =</span> f<span class="op">$</span>fitted.values)</a>
<a class="sourceLine" id="cb1-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">r2_mv</a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co">#&gt; [1] 0.8486348</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="co"># just to be 100% sure...</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">r2_lm <span class="op">==</span><span class="st"> </span>r2_mv</a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>You can also calculate R-squared by passing your data and your linear weights. (That’s probably less useful for univariate outcome models. But, as you’ll see below, it’s very important for latent variable models like topic models.)</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">x &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dv">1</span>, f<span class="op">$</span>model[, <span class="dv">-1</span>]) <span class="co"># note, you have to add 1's for the intercept and</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">                             <span class="co"># I'm removing the first column of f$model as it</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">                             <span class="co"># is the outcome we are predicting</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">x &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(x) <span class="co"># x needs to be a matrix, not a data.frame or tibble for now</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">w &lt;-<span class="st"> </span><span class="kw">matrix</span>(f<span class="op">$</span>coefficients, <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="co"># w also has to be a matrix</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co"># this calculates yhat as the dot product x %*% w</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">r2_mv2 &lt;-<span class="st"> </span><span class="kw">calc_rsquared</span>(<span class="dt">y =</span> mtcars<span class="op">$</span>mpg, </a>
<a class="sourceLine" id="cb2-12" data-line-number="12">                        <span class="dt">yhat =</span> <span class="kw">list</span>(<span class="dt">x =</span> x,</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">                                    <span class="dt">w =</span> w))</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">r2_mv2</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">#&gt; [1] 0.8486348</span></a></code></pre></div>
<p>Calculating R-squared this way does lead to a tiny difference in calculation due to numeric precision.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">r2_mv2 <span class="op">==</span><span class="st"> </span>r2_lm</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; [1] FALSE</span></a></code></pre></div>
<p>However, the difference is tiny. Below demonstrates that they are the same up to 14 decimal places in this example.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">round</span>(r2_mv2, <span class="dv">14</span>) <span class="op">==</span><span class="st"> </span><span class="kw">round</span>(r2_lm, <span class="dv">14</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
</div>
<div id="multivariate-r-squared" class="section level1">
<h1>Multivariate R-squared</h1>
<div id="multivariate-prediction" class="section level2">
<h2>Multivariate prediction</h2>
<div id="a-silly-example-to-prove-a-point" class="section level3">
<h3>A silly example to prove a point</h3>
<p>Below, just to show you I’m not blowing smoke, is a silly example that demonstrates that you don’t get any crazy results just because your outcome is a matrix. If we make the columns of <span class="math inline">\(y\)</span> the same values (and ditto for <span class="math inline">\(\hat{y}\)</span>), you actually get the same R-squared as above.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">calc_rsquared</span>(<span class="dt">y =</span> <span class="kw">cbind</span>(mtcars<span class="op">$</span>mpg, mtcars<span class="op">$</span>mpg),</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">              <span class="dt">yhat =</span> <span class="kw">cbind</span>(f<span class="op">$</span>fitted.values, f<span class="op">$</span>fitted.values))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; [1] 0.8486348</span></a></code></pre></div>
<p>Same as above, no?</p>
</div>
<div id="a-more-realistic-example" class="section level3">
<h3>A more realistic example</h3>
<p>Here’s a more realistic example. Say you’ve got a neural net that is predicting two variables at once.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">library</span>(nnet)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># let's generate some synthetic data</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw">set.seed</span>(<span class="dv">666</span>)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co"># Some continuous variables</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">x1 &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="dv">10000</span>, <span class="dt">mean =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">x2 &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="dv">10000</span>, <span class="dt">mean =</span> <span class="fl">1.5</span>, <span class="dt">sd =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">x3 &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="dv">10000</span>, <span class="dt">mean =</span> <span class="fl">.6</span>, <span class="dt">sd =</span> <span class="fl">1.5</span>)</a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co"># linear combinations used to generate outcomes with logit functions</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">z1 &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="fl">1.2</span> <span class="op">*</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span><span class="fl">4.5</span> <span class="op">*</span><span class="st"> </span>x2 <span class="op">-</span><span class="st"> </span><span class="fl">2.8</span> <span class="op">*</span><span class="st"> </span>x3 </a>
<a class="sourceLine" id="cb6-13" data-line-number="13"></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">z2 &lt;-<span class="st"> </span><span class="dv">-2</span> <span class="op">+</span><span class="st"> </span><span class="fl">2.8</span> <span class="op">*</span><span class="st"> </span>x1 <span class="op">-</span><span class="st"> </span><span class="fl">1.2</span> <span class="op">*</span><span class="st"> </span>x2 <span class="op">+</span><span class="st"> </span><span class="fl">4.5</span> <span class="op">*</span><span class="st"> </span>x3 </a>
<a class="sourceLine" id="cb6-15" data-line-number="15"></a>
<a class="sourceLine" id="cb6-16" data-line-number="16">y1 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="dv">10000</span>, <span class="dv">1</span>, <span class="dt">prob =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>z1)))</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"></a>
<a class="sourceLine" id="cb6-18" data-line-number="18">y2 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="dv">10000</span>, <span class="dv">1</span>, <span class="dt">prob =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>z2)))</a>
<a class="sourceLine" id="cb6-19" data-line-number="19"></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="co"># fit a multinomial model using a 1-layer neural net with 10 nodes</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21">f_mv &lt;-<span class="st"> </span><span class="kw">nnet</span>(<span class="kw">cbind</span>(y1, y2) <span class="op">~</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span>x2 <span class="op">+</span><span class="st"> </span>x3, </a>
<a class="sourceLine" id="cb6-22" data-line-number="22">             <span class="dt">size =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="co">#&gt; # weights:  62</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="co">#&gt; initial  value 6406.585738 </span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="co">#&gt; iter  10 value 3246.812009</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="co">#&gt; iter  20 value 1446.678774</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="co">#&gt; iter  30 value 1060.315445</span></a>
<a class="sourceLine" id="cb6-28" data-line-number="28"><span class="co">#&gt; iter  40 value 1004.698287</span></a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="co">#&gt; iter  50 value 961.043723</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30"><span class="co">#&gt; iter  60 value 932.089225</span></a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="co">#&gt; iter  70 value 907.861456</span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32"><span class="co">#&gt; iter  80 value 901.751981</span></a>
<a class="sourceLine" id="cb6-33" data-line-number="33"><span class="co">#&gt; iter  90 value 899.029455</span></a>
<a class="sourceLine" id="cb6-34" data-line-number="34"><span class="co">#&gt; iter 100 value 896.508832</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="co">#&gt; final  value 896.508832 </span></a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="co">#&gt; stopped after 100 iterations</span></a>
<a class="sourceLine" id="cb6-37" data-line-number="37"></a>
<a class="sourceLine" id="cb6-38" data-line-number="38">yhat &lt;-<span class="st"> </span><span class="kw">predict</span>(f_mv, <span class="kw">data.frame</span>(<span class="dt">x1 =</span> x1, <span class="dt">x2 =</span> x2, <span class="dt">x3 =</span> x3), <span class="dt">type =</span> <span class="st">&quot;raw&quot;</span>)</a>
<a class="sourceLine" id="cb6-39" data-line-number="39"></a>
<a class="sourceLine" id="cb6-40" data-line-number="40"><span class="co"># and now calculate r-squared</span></a>
<a class="sourceLine" id="cb6-41" data-line-number="41"><span class="kw">calc_rsquared</span>(<span class="dt">y =</span> <span class="kw">cbind</span>(y1, y2), <span class="dt">yhat =</span> yhat)</a>
<a class="sourceLine" id="cb6-42" data-line-number="42"><span class="co">#&gt; [1] 0.8094835</span></a></code></pre></div>
</div>
</div>
<div id="probabilistic-topic-modeling" class="section level2">
<h2>Probabilistic topic modeling</h2>
<p><a href="https://arxiv.org/abs/1911.11061">The paper</a> (as of this writing still in progress) that derives the multivariate R-squared is focused on probabilistic topic modeling. Here’s an example using Latent Dirichlet Allocation.</p>
<p>Below are preliminaries of loading data and getting the model.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">library</span>(tidytext)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">library</span>(textmineR)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; Loading required package: Matrix</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; Attaching package: 'textmineR'</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; The following object is masked from 'package:Matrix':</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt;     update</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; The following object is masked from 'package:stats':</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt;     update</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#&gt; Attaching package: 'dplyr'</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#&gt; The following objects are masked from 'package:stats':</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt;     filter, lag</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#&gt; The following objects are masked from 'package:base':</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#&gt;     intersect, setdiff, setequal, union</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb7-22" data-line-number="22"></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co"># load documents in a data frame</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">docs &lt;-<span class="st"> </span>nih_sample </a>
<a class="sourceLine" id="cb7-25" data-line-number="25"></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="co"># tokenize using tidytext's unnest_tokens</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27">tidy_docs &lt;-<span class="st"> </span>docs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28"><span class="st">  </span><span class="kw">select</span>(APPLICATION_ID, ABSTRACT_TEXT) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="st">  </span><span class="kw">unnest_tokens</span>(<span class="dt">output =</span> word, </a>
<a class="sourceLine" id="cb7-30" data-line-number="30">                <span class="dt">input =</span> ABSTRACT_TEXT,</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">                <span class="dt">stopwords =</span> stop_words<span class="op">$</span>word,</a>
<a class="sourceLine" id="cb7-32" data-line-number="32">                <span class="dt">token =</span> <span class="st">&quot;ngrams&quot;</span>,</a>
<a class="sourceLine" id="cb7-33" data-line-number="33">                <span class="dt">n_min =</span> <span class="dv">1</span>, <span class="dt">n =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34"><span class="st">  </span><span class="kw">count</span>(APPLICATION_ID, word) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-35" data-line-number="35"><span class="st">  </span><span class="kw">filter</span>(n<span class="op">&gt;</span><span class="dv">1</span>) <span class="co">#Filtering for words/bigrams per document, rather than per corpus</span></a>
<a class="sourceLine" id="cb7-36" data-line-number="36"></a>
<a class="sourceLine" id="cb7-37" data-line-number="37">tidy_docs &lt;-<span class="st"> </span>tidy_docs <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># filter words that are just numbers</span></a>
<a class="sourceLine" id="cb7-38" data-line-number="38"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="st"> </span><span class="kw">str_detect</span>(tidy_docs<span class="op">$</span>word, <span class="st">&quot;^[0-9]+$&quot;</span>))</a>
<a class="sourceLine" id="cb7-39" data-line-number="39"></a>
<a class="sourceLine" id="cb7-40" data-line-number="40"><span class="co"># turn a tidy tbl into a sparse dgCMatrix for use in textmineR</span></a>
<a class="sourceLine" id="cb7-41" data-line-number="41">dtm &lt;-<span class="st"> </span>tidy_docs <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-42" data-line-number="42"><span class="st">  </span><span class="kw">cast_sparse</span>(APPLICATION_ID, word, n)</a>
<a class="sourceLine" id="cb7-43" data-line-number="43"></a>
<a class="sourceLine" id="cb7-44" data-line-number="44"></a>
<a class="sourceLine" id="cb7-45" data-line-number="45"><span class="co"># create a topic model</span></a>
<a class="sourceLine" id="cb7-46" data-line-number="46">lda &lt;-<span class="st"> </span><span class="kw">FitLdaModel</span>(<span class="dt">dtm =</span> dtm, </a>
<a class="sourceLine" id="cb7-47" data-line-number="47">                   <span class="dt">k =</span> <span class="dv">20</span>,</a>
<a class="sourceLine" id="cb7-48" data-line-number="48">                   <span class="dt">iterations =</span> <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb7-49" data-line-number="49">                   <span class="dt">burnin =</span> <span class="dv">175</span>)</a></code></pre></div>
<p>The paper notes that for a probabilistic topic model, <span class="math inline">\(\hat{y} = \vec{n} \odot \Theta \cdot \Phi\)</span>, where <span class="math inline">\(\vec{n}\)</span> is a vector of document lengths, <span class="math inline">\(\odot\)</span> is elementwise multiplication, <span class="math inline">\(\Theta\)</span> is a matrix of topic distributions over documents, and <span class="math inline">\(\Phi\)</span> is a matrix of token distributions over topics.</p>
<p>Doing this multiplication explicitly in R could lead you to run out of RAM for a decently-sized corpus. (This toy example won’t.) Luckily, we can use the ability to pass a list <code>x</code> and <code>w</code> to <code>calc_rsquared</code> to do that multiplication more efficiently. In that case, we set <code>x</code> <span class="math inline">\(= \vec{n}\odot\Theta\)</span> and <code>w</code> <span class="math inline">\(= \Phi\)</span>.</p>
<p>(Note that you can pass a sparse <code>dgCMatrix</code> from the <code>Matrix</code> or something coercible to one directly to <code>calc_rsquared</code>.)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">r2_lda &lt;-<span class="st"> </span><span class="kw">calc_rsquared</span>(<span class="dt">y =</span> dtm, </a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                        <span class="dt">yhat =</span> <span class="kw">list</span>(<span class="dt">x =</span> <span class="kw">rowSums</span>(dtm) <span class="op">*</span><span class="st"> </span>lda<span class="op">$</span>theta, <span class="dt">w =</span> lda<span class="op">$</span>phi))</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">r2_lda</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt; [1] 0.2885575</span></a></code></pre></div>
</div>
<div id="latent-semantic-analysis-topic-modeling" class="section level2">
<h2>Latent semantic analysis topic modeling</h2>
<p>Latent semantic analysis (LSA) uses a single value decomposition of a document term matrix as a non-probabilistic topic model.</p>
<p>Note the example below doesn’t use <a href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">TF-IDF</a> even though most folks recommend you do. For a more thorough example of LSA (and LDA) see <code>textmineR</code>’s <a href="https://www.rtextminer.com/articles/c_topic_modeling.html">vignette on topic modeling</a>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">lsa &lt;-<span class="st"> </span><span class="kw">FitLsaModel</span>(<span class="dt">dtm =</span> dtm, <span class="dt">k =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">r2_lsa &lt;-<span class="st"> </span><span class="kw">calc_rsquared</span>(<span class="dt">y =</span> dtm,</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">                        <span class="dt">yhat =</span> <span class="kw">list</span>(<span class="dt">x =</span> lsa<span class="op">$</span>theta <span class="op">%*%</span><span class="st"> </span><span class="kw">diag</span>(lsa<span class="op">$</span>sv), <span class="dt">w =</span> lsa<span class="op">$</span>phi))</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">r2_lsa</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt; [1] 0.4539497</span></a></code></pre></div>
</div>
</div>
<div id="parallelizationdistributed-computing-for-large-data-sets" class="section level1">
<h1>Parallelization/distributed computing for large data sets</h1>
<p>You say you have BIG DATA?!?! Below is an example of how to chop up a calculation and have r-squared built in parallel in a distributed setting. <code>mvrsquared</code> has a parallel back end using <a href="https://CRAN.R-project.org/package=RcppThread"><code>RcppThread</code></a> and controlled by the <code>threads</code> argument. However, if that isn’t enough, you can bring your own distributed parallel framework. The example below uses <code>parallel::mclapply</code> which will not parallelize on Windows, but R has other options.</p>
<p><code>mvrsquared</code> has the option to return only the sums of squares (specifically SSE and SST). You can calculate these in parallel/distributed and combine them by adding post-hoc. (That’s a little algorithm called “map-reduce” for those in the know.) Once combined, you can calculate R-squared yourself with the canonical formula <span class="math inline">\(1 - \frac{SSE}{SST}\)</span>.</p>
<p>Note: You <strong>must</strong> calculate the mean of your outcome, <span class="math inline">\(\bar{y}\)</span>, first and hand it off to <code>calc_rsquared</code>. Otherwise, your calculations for SST on a given core will be based only on the observations sent to that core, not the whole data set. (If you do this, <code>calc_rsquared</code> will give you a WARNING.)</p>
<p>Below is a toy example using <code>parallel::mclapply</code> to run parallel computations calculating R-squared for our LDA model, above. (Yes, this is overkill for our toy problem and it will actually be slower due to overhead. But imagine the calculations for a corpus of ~1 million documents with hundreds-of-thousands or millions of unique tokens.)</p>
<p>Because the below example uses parallel execution, which can be tricky when working with CRAN, I’m not actually evaluating it in this vignette. However, you can run the code yourself.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">batch_size &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">batches &lt;-<span class="st"> </span><span class="kw">mclapply</span>(<span class="dt">X =</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(dtm), <span class="dt">by =</span> batch_size),</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">                    <span class="dt">FUN =</span> <span class="cf">function</span>(b){</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">                      </a>
<a class="sourceLine" id="cb10-8" data-line-number="8">                      <span class="co"># rows to select on</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">                      rows &lt;-<span class="st"> </span>b<span class="op">:</span><span class="kw">min</span>(b <span class="op">+</span><span class="st"> </span>batch_size <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="kw">nrow</span>(dtm))</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">                      </a>
<a class="sourceLine" id="cb10-11" data-line-number="11">                      <span class="co"># rows of the dtm</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">                      y_batch &lt;-<span class="st"> </span>dtm[rows, ]</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">                      </a>
<a class="sourceLine" id="cb10-14" data-line-number="14">                      <span class="co"># rows of theta multiplied by document length</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">                      x_batch &lt;-<span class="st"> </span><span class="kw">rowSums</span>(y_batch) <span class="op">*</span><span class="st"> </span>lda<span class="op">$</span>theta[rows, ]</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">                      </a>
<a class="sourceLine" id="cb10-17" data-line-number="17">                      <span class="kw">list</span>(<span class="dt">y =</span> y_batch,</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">                           <span class="dt">x =</span> x_batch)</a>
<a class="sourceLine" id="cb10-19" data-line-number="19">                    }, <span class="dt">mc.cores =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-20" data-line-number="20"></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"></a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="co"># calculate ybar for the data</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23"><span class="co"># in this case, lazily doing colMeans, but you could divide this problem up too</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24">ybar &lt;-<span class="st"> </span><span class="kw">colMeans</span>(dtm)</a>
<a class="sourceLine" id="cb10-25" data-line-number="25"></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="co"># MAP: calculate sums of squares</span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27">ss &lt;-<span class="st"> </span><span class="kw">mclapply</span>(<span class="dt">X =</span> batches,</a>
<a class="sourceLine" id="cb10-28" data-line-number="28">               <span class="dt">FUN =</span> <span class="cf">function</span>(batch){</a>
<a class="sourceLine" id="cb10-29" data-line-number="29">                 <span class="kw">calc_rsquared</span>(<span class="dt">y =</span> batch<span class="op">$</span>y,</a>
<a class="sourceLine" id="cb10-30" data-line-number="30">                               <span class="dt">yhat =</span> <span class="kw">list</span>(<span class="dt">x =</span> batch<span class="op">$</span>x, <span class="dt">w =</span> lda<span class="op">$</span>phi),</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">                               <span class="dt">ybar =</span> ybar,</a>
<a class="sourceLine" id="cb10-32" data-line-number="32">                               <span class="dt">return_ss_only =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-33" data-line-number="33">               }, <span class="dt">mc.cores =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-34" data-line-number="34"></a>
<a class="sourceLine" id="cb10-35" data-line-number="35"></a>
<a class="sourceLine" id="cb10-36" data-line-number="36"><span class="co"># REDUCE: get SST and SSE by summation</span></a>
<a class="sourceLine" id="cb10-37" data-line-number="37">ss &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, ss) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">colSums</span>()</a>
<a class="sourceLine" id="cb10-38" data-line-number="38"></a>
<a class="sourceLine" id="cb10-39" data-line-number="39">r2_mapreduce &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>ss[<span class="st">&quot;sse&quot;</span>] <span class="op">/</span><span class="st"> </span>ss[<span class="st">&quot;sst&quot;</span>]</a>
<a class="sourceLine" id="cb10-40" data-line-number="40"></a>
<a class="sourceLine" id="cb10-41" data-line-number="41"><span class="co"># should be the same as above</span></a>
<a class="sourceLine" id="cb10-42" data-line-number="42">r2_mapreduce</a></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
